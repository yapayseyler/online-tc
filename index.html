<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>MRZ Okuyucu (Ön/Arka Kamera Seçimli)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e6eef8; }
    header { padding:16px 20px; border-bottom:1px solid #1f2733; display:flex; justify-content:space-between; align-items:center;}
    header h1 { font-size:18px; margin:0; }
    main { display:grid; grid-template-columns: 1.3fr 0.7fr; gap:16px; padding:16px; }
    .panel { background:#0f1520; border:1px solid #1d2633; border-radius:12px; overflow:hidden; }
    .panel h2 { font-size:14px; margin:0; padding:10px 12px; border-bottom:1px solid #1d2633; color:#b9c8da;}
    .content { padding:12px; }
    #video { width:100%; border-radius:8px; background:#000; transform: scaleX(-1); }
    /* Ön kamera ayna etkisi için scaleX(-1). Arka kameraya geçtiğinde JS ile kaldırıyoruz. */
    #overlay { position:absolute; inset:0; pointer-events:none; }
    .stack { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button { border:1px solid #2a3547; background:#162032; color:#e6eef8; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button:disabled{opacity:.6; cursor:wait;}
    .hint { font-size:12px; color:#9bb0c9; line-height:1.5; }
    pre { white-space:pre-wrap; background:#0c111b; padding:10px; border-radius:8px; border:1px solid #1d2633; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap:6px; font-size:14px; padding:6px 8px; border-bottom:1px dashed #223049; }
    .kv b { color:#cfe1ff; }
    footer { padding:10px 16px; font-size:12px; color:#8fa8c7; border-top:1px solid #1f2733; }
    .frame { position:relative; }
    .mrz-window {
      position:absolute; left:5%; right:5%; height:26%;
      bottom:8%; border:2px dashed #58a6ff88; border-radius:8px; box-shadow:0 0 0 200vmax #0000 inset;
    }
    .grid { display:grid; gap:8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- MRZ ayrıştırıcı (ESM) -->
  <script type="module" id="mrz-module">
    import { parse as parseMrz } from 'https://unpkg.com/mrz@4.2.1/lib-esm/index.js';
    window.__parseMrz = parseMrz;
  </script>
</head>
<body>
  <header>
    <h1>MRZ Okuyucu — HTML + Tesseract.js</h1>
    <div class="stack">
      <button id="startBtn">Kamerayı Aç (Ön)</button>
      <button id="switchBtn" disabled>Ön ⇄ Arka</button>
      <button id="snapBtn" disabled>Tara</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Kamera</h2>
      <div class="content grid">
        <div class="frame">
          <video id="video" autoplay playsinline></video>
          <div class="mrz-window" title="MRZ penceresi"></div>
        </div>
        <div class="two">
          <div>
            <div class="hint">
              • MRZ, belgenin altındaki 2–3 satırlık makine okunur alandır.<br/>
              • MRZ penceresini o alana denk getirecek şekilde tut.<br/>
              • Işık iyi olmalı; parlamadan kaçın.
            </div>
          </div>
          <div>
            <div class="hint">
              İpucu: Sonuçlar zayıfsa belgeyi düz tut, kameraya paralel hizala ve tekrar tara.
            </div>
          </div>
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>Sonuç</h2>
      <div class="content grid">
        <div>
          <div id="status" class="hint">Hazır.</div>
          <pre id="rawText" class="mono"></pre>
        </div>
        <div id="fields"></div>
      </div>
    </section>
  </main>

  <footer>
    Bu örnek, tarayıcıda çalışan açık kaynak Tesseract.js ile MRZ ayrıştırıcıyı kullanır (kamera erişimi gerekli).
  </footer>

<script>
(function(){
  const startBtn = document.getElementById('startBtn');
  const switchBtn= document.getElementById('switchBtn');
  const snapBtn  = document.getElementById('snapBtn');
  const video    = document.getElementById('video');
  const canvas   = document.getElementById('canvas');
  const statusEl = document.getElementById('status');
  const rawText  = document.getElementById('rawText');
  const fieldsEl = document.getElementById('fields');

  let stream = null;
  // Varsayılan: ÖN (user). İstersen butonla arka (environment) yapılır.
  let facing = 'user';

  function setStatus(msg){ statusEl.textContent = msg; }
  function setBusy(b){ snapBtn.disabled = b || !stream; startBtn.disabled = b; switchBtn.disabled = b || !stream; }

  function applyMirror(){
    // Ön kamera için aynalama, arka kamera için normal
    if(facing === 'user'){
      video.style.transform = 'scaleX(-1)';
    }else{
      video.style.transform = '';
    }
  }

  function stopStream(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    snapBtn.disabled = true;
    switchBtn.disabled = true;
  }

  async function openCamera(){
    try{
      stopStream();
      setStatus((facing==='user'?'Ön':'Arka') + ' kamera açılıyor…');
      const constraints = {
        video: { facingMode: { ideal: facing } }, // 'user' = ön, 'environment' = arka
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      applyMirror();
      setStatus('Kamera hazır. MRZ alanını çerçeve içine getir ve "Tara"ya bas.');
      snapBtn.disabled = false;
      switchBtn.disabled = false;
    }catch(err){
      console.error(err);
      setStatus('Kamera açılamadı: ' + (err.message || err));
      snapBtn.disabled = true;
      switchBtn.disabled = true;
    }
  }

  function takeMrzCrop(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if(!vw || !vh){ throw new Error('Video hazır değil.'); }

    // MRZ penceresini video boyutuna göre kes: soldan %5, sağdan %5, alttan %8 boşluk; yükseklik %26
    const x = Math.round(vw * 0.05);
    const w = Math.round(vw * 0.90);
    const h = Math.round(vh * 0.26);
    const y = Math.round(vh * 0.66); // alt kısım

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');

    if(facing === 'user'){
      // Ön kamera aynalı olduğu için crop'ta geri çeviriyoruz
      ctx.translate(w, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

    return canvas;
  }

  function normalizeMrzText(t){
    const keep = /[A-Z0-9<\n]/g;
    const up = (t || '').toUpperCase().match(keep)?.join('') || '';
    return up.replace(/ /g,'').replace(/\u00A0/g,'');
  }

  function pickMrzLines(text){
    const lines = text.split(/\n+/).map(s => s.trim()).filter(Boolean);
    const candidates = lines.filter(s => s.length >= 25);
    return candidates.slice(-3);
  }

  function renderFields(obj){
    const kv = [];
    function row(k, v){ kv.push(`<div class="kv"><b>${k}</b><span>${v ?? ''}</span></div>`); }
    fieldsEl.innerHTML = '';

    if(!obj || !obj.fields){
      fieldsEl.innerHTML = '<div class="hint">MRZ ayrıştırılamadı. Farklı açı/ışıkla tekrar deneyin.</div>';
      return;
    }

    const f = obj.fields;
    row('Belge türü', f.documentType);
    row('Ülke', f.issuingCountry);
    row('Soyad', f.lastName);
    row('İsimler', f.firstName);
    row('Belge No', f.documentNumber);
    row('Uyruk', f.nationality);
    row('Doğum Tarihi', f.birthDate);
    row('Cinsiyet', f.sex);
    row('Son Geçerlilik', f.expirationDate);
    row('Opsiyonel Alan', f.optional);
    fieldsEl.innerHTML = kv.join('');
  }

  async function scan(){
    if(!window.__parseMrz){
      setStatus('MRZ ayrıştırıcı yüklenmedi.');
      return;
    }
    setBusy(true);
    try{
      const cropCanvas = takeMrzCrop();

      setStatus('OCR çalışıyor… (Tesseract.js)');
      const { data } = await Tesseract.recognize(
        cropCanvas,
        'eng',
        {
          logger: m => { if(m.status) setStatus(`${m.status}… ${Math.round((m.progress||0)*100)}%`); },
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
          preserve_interword_spaces: '1',
          user_defined_dpi: '300',
          oem: 1
        }
      );

      const normalized = normalizeMrzText(data.text);
      rawText.textContent = normalized || '(metin bulunamadı)';

      const lines = pickMrzLines(normalized);
      let mrzBlock = '';
      if(lines.length >= 3){
        const last3 = lines.slice(-3);
        if(last3[0].length >= 28 && last3[1].length >= 28 && last3[2].length >= 28){
          mrzBlock = last3.join('\n');
        }
      }
      if(!mrzBlock && lines.length >= 2){
        mrzBlock = lines.slice(-2).join('\n');
      }

      if(!mrzBlock){
        setStatus('MRZ bulunamadı. Yeniden deneyin.');
        renderFields(null);
        return;
      }

      setStatus('MRZ ayrıştırılıyor…');
      const parsed = window.__parseMrz(mrzBlock);
      renderFields(parsed);
      setStatus('Bitti ✅');
    }catch(err){
      console.error(err);
      setStatus('Hata: ' + (err.message || err));
      renderFields(null);
    }finally{
      setBusy(false);
    }
  }

  startBtn.addEventListener('click', openCamera);

  switchBtn.addEventListener('click', async () => {
    // facing değerini değiştirip kamerayı yeniden aç
    facing = (facing === 'user') ? 'environment' : 'user';
    startBtn.textContent = 'Kamerayı Aç (' + (facing==='user'?'Ön':'Arka') + ')';
    await openCamera();
  });

  snapBtn.addEventListener('click', scan);
})();
</script>
</body>
</html>

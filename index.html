<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Online TC — Sadece MRZ (</> arındırılmış)</title>
<style>
  :root{--bg:#0f1115;--card:#171923;--ink:#e8e8ea;--muted:#9aa0a6;--acc:#4f8cff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:14px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 30px rgb(0 0 0/.25);padding:14px;margin:12px 0}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:var(--acc);color:#fff;font-weight:600}
  button.secondary{background:#2a2e3a} button.danger{background:#e54848}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{font-size:13px;color:var(--muted)}
  select,input[type="checkbox"]{padding:8px;border-radius:8px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  textarea{min-height:90px}
  .video-wrap{position:relative;border:1px solid #2b2f3a;border-radius:12px;overflow:hidden}
  video{width:100%;max-height:55vh;background:#000}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
  .overlay button{background:#000;border:1px solid #444}
  .scanline{position:absolute;left:0;right:0;top:45%;height:2px;background:rgba(79,140,255,.9);box-shadow:0 0 14px rgba(79,140,255,.9);animation:scan 2.2s linear infinite;display:none}
  @keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}
  pre{white-space:pre-wrap;background:#0e1016;border:1px solid #2b2f3a;padding:12px;border-radius:12px;max-height:32vh;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:700px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2b2f3a;font-size:14px;word-break:break-word}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202431;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Online TC — Sadece MRZ <span class="pill">“&lt;” arındırılmış</span></h1>
    <div class="row" style="margin-top:6px">
      <button id="btnOpen">Kamerayı Aç</button>
      <button id="btnMRZ" class="secondary" disabled>MRZ Tara</button>
      <button id="btnStop" class="secondary" disabled>Durdur</button>
      <button id="btnExport" class="secondary" disabled>TXT dışa aktar</button>
      <button id="btnClear" class="danger" disabled>Tüm kayıtları sil</button>
      <span id="status" style="color:#cbd5e1">Hazır.</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <label>Kamera</label>
      <select id="camera"></select>
      <label><input type="checkbox" id="lowres"> Düşük çözünürlük (1280×720)</label>
    </div>
    <div class="video-wrap">
      <video id="video" autoplay playsinline muted></video>
      <div class="overlay" id="tapOverlay"><button id="btnTap">Videoyu Başlat</button></div>
      <div class="scanline" id="scanline"></div>
    </div>
  </div>

  <div class="card">
    <h1>Sonuç / Düzenle</h1>
    <div class="grid" style="margin-top:8px">
      <div><label>TC Kimlik No</label><input id="tckn" placeholder="11 haneli"/></div>
      <div><label>Ad</label><input id="ad"/></div>
      <div><label>Soyad</label><input id="soyad"/></div>
      <div><label>Doğum (YYYY-MM-DD)</label><input id="dogum" placeholder="1990-01-31"/></div>
    </div>
    <label style="margin-top:10px;display:block">Ham veri</label>
    <textarea id="raw" rows="4" spellcheck="false"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnSave">Kaydet</button>
      <span class="muted">Kaydetmeden önce kontrol edin.</span>
    </div>
  </div>

  <div class="card">
    <h1>Kayıtlar</h1>
    <div class="muted" style="margin-bottom:6px">Veriler localStorage’da tutulur.</div>
    <table id="tbl"><thead><tr><th>#</th><th>TCKN</th><th>Ad</th><th>Soyad</th><th>Doğum</th><th>Sil</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <details><summary style="cursor:pointer">Teşhis Günlüğü</summary><pre id="log"></pre></details>
  </div>
</div>

<script>
/* ==================== Yardımcılar / Log ==================== */
const $ = s=>document.querySelector(s);
const log = (...a)=>{ const t=a.map(x=>x instanceof Error?(x.stack||x):typeof x==='object'?JSON.stringify(x):String(x)).join(' '); $('#log').textContent += t + "\n"; console.log(...a); };
const setStatus = t => $('#status').textContent = t;
const showScanline = b => $('#scanline').style.display = b ? 'block' : 'none';
window.addEventListener('error', e=>{ log('window.error:', {msg:e.message,file:e.filename,line:e.lineno,col:e.colno}); });
window.addEventListener('unhandledrejection', ev=>{ log('unhandledrejection:', ev.reason && (ev.reason.stack||ev.reason)); });

/* ==================== Script loader & Tesseract ==================== */
function loadScript(u){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=u;s.async=true;s.crossOrigin='anonymous';s.onload=()=>res();s.onerror=()=>rej(new Error('yüklenemedi:'+u));document.head.appendChild(s);});}
async function loadTesseract(){
  if(window.Tesseract) return true;
  for(const u of ['/vendor/tesseract/tesseract.min.js','https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js']){
    try{ await loadScript(u); return true; }catch(e){ log('tesseract deneme:',u,e.message); }
  }
  return false;
}

/* ==================== Global Durum ==================== */
let devices=[], deviceIndex=0, currentStream=null, currentMode=null;
let scanTimer=null;
let mrzWorker=null, mrzBusy=false;
const storeKey='tcid_records_v1';

/* Stabilizasyon */
const stab={N:5,l1:[],l2:[],l3:[]};
function pushStab(k,v){ if(!v) return; const a=stab[k]; a.push(v); if(a.length>stab.N) a.shift(); }
function majority(a){ const m=new Map(); a.forEach(s=>m.set(s,(m.get(s)||0)+1)); let b='',c=0; for(const [s,n] of m){ if(n>c || (n===c && s.length>b.length)){ b=s;c=n; } } return b; }

/* ==================== Depo ==================== */
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch(_){ return []; } }
function saveRecords(l){ localStorage.setItem(storeKey, JSON.stringify(l||[])); renderTable(); toggleExportButtons(); }
function renderTable(){
  const tb=$('#tbl tbody'); const list=loadRecords(); tb.innerHTML='';
  list.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.tckn||''}</td><td>${r.ad||''}</td><td>${r.soyad||''}</td><td>${r.dogum||''}</td><td><button class="danger" data-i="${i}">Sil</button></td>`; tb.appendChild(tr); });
  tb.querySelectorAll('button[data-i]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.i; const l=loadRecords(); l.splice(i,1); saveRecords(l); });
}
function toggleExportButtons(){ const any=loadRecords().length>0; $('#btnExport').disabled=!any; $('#btnClear').disabled=!any; }
renderTable(); toggleExportButtons();

/* ==================== Normalizasyon & Doğrulama ==================== */
function normalizeDigits(s){ return (s||'').replace(/O/g,'0').replace(/D/g,'0').replace(/[IL]/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8').replace(/G/g,'6'); }
function isValidTCKN(n){
  if(!/^\d{11}$/.test(n) || n[0]==='0') return false;
  const d=n.split('').map(Number), o=d[0]+d[2]+d[4]+d[6]+d[8], e=d[1]+d[3]+d[5]+d[7];
  const d10=((o*7 - e)%10+10)%10; if(d10!==d[9]) return false;
  const d11=d.slice(0,10).reduce((a,b)=>a+b,0)%10; return d11===d[10];
}
function yyyyFromYY(yy){ const y=+yy; return y<=24?2000+y:1900+y; }

/* ==================== MRZ Ayrıştırıcı (’<’ kullanılmadan) ==================== */
function parseMRZ_TR(text){
  if(!text) return null;
  const L = text.trim().split(/\n+/).map(s=>s.toUpperCase());
  const l1=(L[0]||'').replace(/\s+/g,' ');
  const l2=(L[1]||'').replace(/\s+/g,' ');
  const l3=(L[2]||'').replace(/\s+/g,' ');

  // 1) L1: sağdaki 11 rakam → TCKN
  let tckn='';{
    const only=normalizeDigits(l1).replace(/\D/g,'');
    const m=only.match(/(\d{11})$/); if(m && isValidTCKN(m[1])) tckn=m[1];
  }
  // 2) L2: soldaki 6 rakam → YYMMDD
  let dogum='';{
    const m=normalizeDigits(l2).match(/^\s*(\d{6})/);
    if(m){ const p=m[1]; const yy=p.slice(0,2), mm=p.slice(2,4), dd=p.slice(4,6);
      const Y=yyyyFromYY(yy), M=+mm, D=+dd;
      if(M>=1&&M<=12&&D>=1&&D<=31) dogum=`${Y}-${mm}-${dd}`;
    }
  }
  // 3) L3: SOYAD  AD (’<’ yok; iki+ boşluk ayırıcı kabul)
  let ad='', soyad='';{
    const onlyLetters=l3.replace(/[^A-Z ]/g,' ').replace(/\s{2,}/g,'  ').trim(); // iki boşluğu koru
    let m = onlyLetters.match(/^([A-Z ]+?)\s{2,}([A-Z ]+)$/);
    if(m){ soyad=m[1].trim().replace(/\s+/g,' '); ad=m[2].trim().replace(/\s+/g,' '); }
    else{
      // fallback: ilk boşluk öncesi soyad, kalanı ad
      const parts=onlyLetters.trim().split(/\s+/);
      if(parts.length){ soyad=parts.shift(); ad=parts.join(' '); }
    }
  }
  if(!(tckn||dogum||ad||soyad)) return null;
  return {tckn, dogum, ad, soyad};
}

/* ==================== Kamera ==================== */
function preferBack(list){
  const score=d=>{ const L=(d.label||'').toLowerCase(); let s=0; if(/back|rear|environment/.test(L)) s+=5; if(/front|user/.test(L)) s-=4; if(/camera\s*0.*back/.test(L)) s+=2; return s; };
  return list.slice().sort((a,b)=>score(b)-score(a));
}
async function listCameras(){ try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch(_){ } let all=await navigator.mediaDevices.enumerateDevices(); all=all.filter(d=>d.kind==='videoinput'); devices=preferBack(all); const sel=$('#camera'); sel.innerHTML=''; devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(o); }); deviceIndex=0; sel.value='0'; }
function waitForFirstFrame(v){ return new Promise(r=>{ if(v.readyState>=2&&v.videoWidth>0) return r(); let done=false; const ok=()=>{ if(!done && v.videoWidth>0){ done=true; r(); } }; v.addEventListener('canplay',()=>ok(),{once:true}); if('requestVideoFrameCallback' in v){ v.requestVideoFrameCallback(()=>ok()); } else { const iv=setInterval(()=>{ if(done) return clearInterval(iv); if(v.videoWidth>0){ clearInterval(iv); ok(); } },50);} setTimeout(()=>ok(),3000); }); }
async function tryPlay(v){ try{ v.muted=true; v.setAttribute('muted',''); v.setAttribute('playsinline',''); await v.play(); $('#tapOverlay').style.display='none'; return true; }catch(e){ $('#tapOverlay').style.display='flex'; return new Promise(res=>{ $('#btnTap').onclick=async()=>{ try{ await v.play(); $('#tapOverlay').style.display='none'; res(true); }catch{ res(false); } }; }); } }
async function stopAll(){ showScanline(false); if(scanTimer){ clearInterval(scanTimer); scanTimer=null; } if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); } currentStream=null; currentMode=null; $('#btnMRZ').disabled=true; $('#btnStop').disabled=true; }
async function openCamera(){
  await stopAll();
  const dev=devices[deviceIndex]; if(!dev){ setStatus('Kamera bulunamadı.'); return false; }
  const low=$('#lowres').checked;
  const constraints={ video:{ deviceId:{exact:dev.deviceId}, facingMode:'environment', width: low?{ideal:1280}:{ideal:1920}, height: low?{ideal:720}:{ideal:1080}, frameRate:{ideal:30}, advanced:[{focusMode:'continuous'}]}, audio:false };
  setStatus('Kamera açılıyor…');
  const v=$('#video');
  try{
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    currentStream=stream; v.srcObject=stream;
    const played=await tryPlay(v); if(!played){ setStatus('Videoyu başlatmak için dokunun.'); return false; }
    await waitForFirstFrame(v);
    setStatus('Kamera açık.');
    $('#btnMRZ').disabled=false; $('#btnStop').disabled=false;
    return true;
  }catch(e){ log('getUserMedia:', e.name, e.message); setStatus('Kamera açılamadı: '+e.message); return false; }
}

/* ==================== Görüntü işleme ==================== */
function binarize(ctx,w,h,thr=140){ const img=ctx.getImageData(0,0,w,h), d=img.data; for(let i=0;i<d.length;i+=4){ const g=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114)|0; const bw=g>thr?255:0; d[i]=d[i+1]=d[i+2]=bw; } ctx.putImageData(img,0,0); }
function sharpen(ctx,w,h){ const img=ctx.getImageData(0,0,w,h), d=img.data.slice(); const out=ctx.getImageData(0,0,w,h), o=out.data; const off=[-w*4,0,w*4,-4,4]; for(let i=0;i<o.length;i+=4){ let sum=0,cnt=0; for(const k of off){ const j=i+k; if(j>=0 && j<d.length){ const g=(d[j]*0.299+d[j+1]*0.587+d[j+2]*0.114)|0; sum+=g; cnt++; } } const center=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114)|0; let val=Math.min(255,Math.max(0,center*1.5-(sum/cnt)*0.5)); o[i]=o[i+1]=o[i+2]=val; o[i+3]=255; } ctx.putImageData(out,0,0); }

/* ==================== Tesseract Worker ==================== */
async function ensureMRZWorker(){
  if(mrzWorker) return true;
  const ok=await loadTesseract(); if(!ok){ setStatus('Tesseract yüklenemedi.'); return false; }
  try{
    if(Tesseract.createWorker){
      mrzWorker=await Tesseract.createWorker({logger:null});
      await mrzWorker.load(); await mrzWorker.loadLanguage('eng'); await mrzWorker.initialize('eng');
      // *** ÖNEMLİ: '<' whitelist dışı — tamamen yok sayıyoruz
      await mrzWorker.setParameters({ tessedit_pageseg_mode:'7', tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' });
      return true;
    }else{ mrzWorker='legacy'; return true; }
  }catch(e){ log('worker:', e); setStatus('MRZ worker hatası.'); return false; }
}
async function ocrWithWorker(canvas, params){
  if(mrzWorker==='legacy'){ const r=await Tesseract.recognize(canvas,'eng',params||{}); return {text:r?.data?.text||'', conf:r?.data?.confidence||0}; }
  if(params) await mrzWorker.setParameters(params);
  const r=await mrzWorker.recognize(canvas); return {text:r?.data?.text||'', conf:r?.data?.confidence||0};
}

/* ==================== MRZ Tarama (yalnız MRZ bandı) ==================== */
async function startMRZ(){
  if(!currentStream){ const ok=await openCamera(); if(!ok) return; }
  const okW=await ensureMRZWorker(); if(!okW) return;

  currentMode='mrz'; showScanline(true); setStatus('MRZ taranıyor…');
  const v=$('#video');
  const band=document.createElement('canvas'), bctx=band.getContext('2d');
  stab.l1=[]; stab.l2=[]; stab.l3=[]; mrzBusy=false;

  const thresholds=[110,125,140,160];
  function variants(srcCtx,sx,sy,sw,sh,scale){ const arr=[]; for(const thr of thresholds){ const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=Math.max(700,Math.floor(sw*scale)); c.height=Math.floor(sh*scale); x.drawImage(srcCtx.canvas,sx,sy,sw,sh,0,0,c.width,c.height); sharpen(x,c.width,c.height); binarize(x,c.width,c.height,thr); arr.push(c); } return arr; }
  async function bestText(cans){ let best='',q=-1; for(const c of cans){ const {text,conf}=await ocrWithWorker(c); const t=(text||'').toUpperCase().replace(/[^A-Z0-9\n ]/g,'').trim(); if(!t) continue; const score=(conf||0)+t.length*1.5; if(score>q){ q=score; best=t; } } return best; }

  const tick=async()=>{
    if(currentMode!=='mrz'||mrzBusy||!v.videoWidth) return;
    mrzBusy=true;
    try{
      const vw=v.videoWidth, vh=v.videoHeight, bandH=Math.floor(vh*0.34), bandY=vh-bandH, scale=2;
      band.width=Math.floor(vw*scale); band.height=Math.floor(bandH*scale);
      bctx.drawImage(v,0,bandY,vw,bandH,0,0,band.width,band.height);
      binarize(bctx,band.width,band.height,135);

      const h=Math.floor(band.height/3);
      const v1=variants(bctx,0,0*h,band.width,h,1.8);
      const v2=variants(bctx,0,1*h,band.width,h,1.8);
      const v3=variants(bctx,0,2*h,band.width,h,2.0);

      const l2=await bestText(v2);
      const l3=await bestText(v3);
      const l1=await bestText(v1);

      pushStab('l1',l1); pushStab('l2',l2); pushStab('l3',l3);
      const s1=majority(stab.l1), s2=majority(stab.l2), s3=majority(stab.l3);
      const cleaned=[s1,s2,s3].filter(Boolean).join('\n');

      if(cleaned.replace(/\s/g,'').length>20){
        const parsed=parseMRZ_TR(cleaned);
        if(parsed){ parsed.raw=cleaned; onScan(cleaned,'mrz',parsed); showScanline(false); }
        else{ setStatus('MRZ yakalandı; ayrıştırılamadı.'); $('#raw').value=cleaned; }
      }else{
        setStatus('MRZ bekleniyor… Kartı alt banda hizalayın.');
      }
    }catch(e){ log('MRZ tick:',e); } finally{ mrzBusy=false; }
  };
  scanTimer=setInterval(tick,600);
}

/* ==================== Ortak Sonuç ==================== */
function fillForm(o){ if(!o) return; $('#tckn').value=o.tckn||''; $('#ad').value=o.ad||''; $('#soyad').value=o.soyad||''; $('#dogum').value=o.dogum||''; if(o.raw) $('#raw').value=o.raw; }
function onScan(text, _src, parsed){ $('#raw').value=text||''; const obj=parsed||{}; obj.raw=text; fillForm(obj); setStatus('MRZ okundu.'); }

/* ==================== UI ==================== */
$('#btnOpen').addEventListener('click', async ()=>{ try{ await listCameras(); await openCamera(); }catch(e){ log('btnOpen:',e); } });
$('#btnStop').addEventListener('click', async ()=>{ await stopAll(); setStatus('Durduruldu.'); });
$('#btnMRZ').addEventListener('click', async ()=>{ try{ await startMRZ(); }catch(e){ log('mrz:',e); } });
$('#camera').addEventListener('change', async ()=>{ deviceIndex=+$('#camera').value; if(currentStream){ await openCamera(); } });

$('#btnSave').addEventListener('click', ()=>{ const rec={ tckn:$('#tckn').value.trim(), ad:$('#ad').value.trim(), soyad:$('#soyad').value.trim(), dogum:$('#dogum').value.trim(), raw:$('#raw').value.trim(), ts:new Date().toISOString() }; const l=loadRecords(); l.push(rec); saveRecords(l); setStatus('Kayıt eklendi.'); });
$('#btnClear').addEventListener('click', ()=>{ if(confirm('Tüm kayıtlar silinsin mi?')) saveRecords([]); });
$('#btnExport').addEventListener('click', ()=>{ const l=loadRecords(); if(!l.length){ alert('Dışa aktarılacak kayıt yok.'); return; } const header='TCKN;AD;SOYAD;DOGUM_TARIHI;RAW\n'; const lines=l.map(r=>[r.tckn||'',r.ad||'',r.soyad||'',r.dogum||'',(r.raw||'').replace(/\n/g,' ')].join(';')); const blob=new Blob(['\ufeff'+header+lines.join('\n')],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kimlik_kayitlari.txt'; document.body.appendChild(a); a.click(); a.remove(); setStatus('TXT dışa aktarıldı.'); });

(async()=>{ try{ await listCameras(); }catch(e){ log('listeleme:',e); } })();
toggleExportButtons();
</script>
</body>
</html>

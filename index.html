<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Online TC — MRZ (Fotoğraf ile Yüksek Kalite)</title>
<style>
  :root{--bg:#0f1115;--card:#171923;--ink:#e8e8ea;--muted:#9aa0a6;--acc:#4f8cff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 30px rgb(0 0 0/.25);padding:14px;margin:12px 0}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:var(--acc);color:#fff;font-weight:600}
  button.secondary{background:#2a2e3a} button.danger{background:#e54848}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{font-size:13px;color:var(--muted)}
  select,input[type="checkbox"]{padding:8px;border-radius:8px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  textarea{min-height:90px}
  .video-wrap{position:relative;border:1px solid #2b2f3a;border-radius:12px;overflow:hidden}
  video{width:100%;max-height:50vh;background:#000}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
  .overlay button{background:#000;border:1px solid #444}
  .scanline{position:absolute;left:0;right:0;bottom:34%;height:2px;background:rgba(79,140,255,.9);box-shadow:0 0 14px rgba(79,140,255,.9)}
  .hint{font-size:12px;color:#9aa0a6}
  pre{white-space:pre-wrap;background:#0e1016;border:1px solid #2b2f3a;padding:12px;border-radius:12px;max-height:30vh;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:700px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2b2f3a;font-size:14px;word-break:break-word}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202431;color:#cbd5e1;font-size:12px}
  .img-prev{max-width:100%;border:1px dashed #394150;border-radius:10px}
  .camera-controls{margin-bottom:12px}
  .scan-button-wrapper{margin-top:12px;text-align:center}
  .scan-button{background:var(--acc);color:#fff;font-size:16px;font-weight:600;padding:12px 24px;border-radius:12px;border:none;cursor:pointer;transition:all 0.2s ease}
  .scan-button:hover{background:#3d7ae6;transform:translateY(-1px)}
  .scan-button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Online TC — Sadece MRZ <span class="pill">Fotoğraf ile daha net</span></h1>
    <div class="row" style="margin-top:6px">
      <button id="btnOpen">Kamerayı Aç</button>
      <button id="btnSnap" class="secondary" disabled>Fotoğraf Çek</button>
      <input type="file" id="file" accept="image/*" style="display:none">
      <button id="btnUpload" class="secondary">Fotoğraf Yükle</button>
      <button id="btnStop" class="secondary" disabled>Durdur</button>
      <button id="btnExport" class="secondary" disabled>TXT dışa aktar</button>
      <button id="btnClear" class="danger" disabled>Tüm kayıtları sil</button>
      <span id="status" style="color:#cbd5e1">Hazır.</span>
    </div>
    <div class="hint">İpucu: "Fotoğraf Çek" görüntü kalitesini video karesine göre ciddi artırır. MRZ bandı kartın <b>altındaki son 1/3</b> bölgedir.</div>
  </div>

  <!-- Kamera alanı üste taşındı -->
  <div class="card">
    <div class="camera-controls">
      <div class="row">
        <label>Kamera</label>
        <select id="camera"></select>
        <label><input type="checkbox" id="lowres"> Düşük çözünürlük (1280×720)</label>
      </div>
    </div>
    <div class="video-wrap">
      <video id="video" autoplay playsinline muted></video>
      <div class="overlay" id="tapOverlay"><button id="btnTap">Videoyu Başlat</button></div>
      <div class="scanline"></div>
    </div>
    <!-- Tara butonu kamera alanının hemen altına yerleştirildi -->
    <div class="scan-button-wrapper">
      <button id="btnMRZ" class="scan-button" disabled>MRZ Tara</button>
    </div>
    <div class="row" style="margin-top:8px">
      <img id="preview" class="img-prev" alt="Seçili fotoğraf önizleme"/>
    </div>
  </div>

  <div class="card">
    <h1>Sonuç / Düzenle</h1>
    <div class="grid" style="margin-top:8px">
      <div><label>TC Kimlik No</label><input id="tckn" placeholder="11 haneli"/></div>
      <div><label>Ad</label><input id="ad"/></div>
      <div><label>Soyad</label><input id="soyad"/></div>
      <div><label>Doğum (YYYY-MM-DD)</label><input id="dogum" placeholder="1990-01-31"/></div>
      <div><label>Telefon</label><input id="telefon" placeholder="05XX XXX XX XX"/></div>
    </div>
    <label style="margin-top:10px;display:block">Ham veri</label>
    <textarea id="raw" rows="4" spellcheck="false"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnSave">Kaydet</button>
      <span class="muted">Kaydetmeden önce kontrol edin.</span>
    </div>
  </div>

  <div class="card">
    <h1>Kayıtlar</h1>
    <div class="muted" style="margin-bottom:6px">Veriler cihazınızda (localStorage) tutulur.</div>
    <table id="tbl"><thead><tr><th>#</th><th>TCKN</th><th>Ad</th><th>Soyad</th><th>Doğum</th><th>Telefon</th><th>Sil</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <details><summary style="cursor:pointer">Teşhis Günlüğü</summary><pre id="log"></pre></details>
  </div>
</div>

<script>
/* ==================== Yardımcı / Log ==================== */
const $ = s=>document.querySelector(s);
const log = (...a)=>{ const t=a.map(x=>x instanceof Error?(x.stack||x):typeof x==='object'?JSON.stringify(x):String(x)).join(' '); $('#log').textContent += t + "\n"; console.log(...a); };
const setStatus = t => $('#status').textContent = t;
window.addEventListener('error', e=>{ log('window.error:', {msg:e.message,file:e.filename,line:e.lineno,col:e.colno}); });
window.addEventListener('unhandledrejection', ev=>{ log('unhandledrejection:', ev.reason && (ev.reason.stack||ev.reason)); });

/* ==================== Tesseract yükleyici (Vendor öncelikli) ==================== */
function loadScript(u){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=u;s.async=true;s.onload=()=>res();s.onerror=()=>rej(new Error('yüklenemedi:'+u));document.head.appendChild(s);});}
function guessTessBaseFromScript(){
  const scr=[...document.scripts].map(x=>x.src||'');
  const hit=scr.find(x=>/tesseract(\.min)?\.js$/i.test(x));
  if(hit){ try{ const u=new URL(hit, location.href); return u.pathname.replace(/[^/]+$/,''); }catch(_){ } }
  return '/vendor/tesseract/'; // varsayılan
}
async function loadTesseract(){
  if(window.Tesseract) return true;
  const cand=[
    './tesseract.min.js',
    './tesseract.js',
    '/vendor/tesseract/tesseract.min.js',
    '/vendor/tesseract/tesseract.js'
  ];
  for(const u of cand){
    try{ await loadScript(u); log('tesseract yüklendi (vendor):',u); return true; }
    catch(e){ log('tesseract vendor denemesi:',u,e.message); }
  }
  // CDN en sona bırakıldı (çoğu ağda engelli)
  const cdn='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js';
  try{ await loadScript(cdn); log('tesseract yüklendi (CDN):',cdn); return true; }
  catch(e){ log('tesseract CDN başarısız:', e.message); return false; }
}

/* ==================== Global Durum ==================== */
let devices=[], deviceIndex=0, currentStream=null;
let selectedImage=null;
const storeKey='tcid_records_v1';

/* ==================== Depo ==================== */
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch(_){ return []; } }
function saveRecords(l){ localStorage.setItem(storeKey, JSON.stringify(l||[])); renderTable(); toggleExportButtons(); }
function renderTable(){
  const tb=$('#tbl tbody'); const list=loadRecords(); tb.innerHTML='';
  list.forEach((r,i)=>{ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${i+1}</td><td>${r.tckn||''}</td><td>${r.ad||''}</td><td>${r.soyad||''}</td><td>${r.dogum||''}</td><td>${r.telefon||''}</td><td><button class="danger" data-i="${i}">Sil</button></td>`; 
    tb.appendChild(tr); 
  });
  tb.querySelectorAll('button[data-i]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.i; const l=loadRecords(); l.splice(i,1); saveRecords(l); });
}
function toggleExportButtons(){ const any=loadRecords().length>0; $('#btnExport').disabled=!any; $('#btnClear').disabled=!any; }
renderTable(); toggleExportButtons();

/* ==================== Normalizasyon & Doğrulama ==================== */
function normalizeDigits(s){ return (s||'').replace(/[OD]/g,'0').replace(/[IL]/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8').replace(/G/g,'6'); }
function isValidTCKN(n){
  if(!/^\d{11}$/.test(n) || n[0]==='0') return false;
  const d=n.split('').map(Number), o=d[0]+d[2]+d[4]+d[6]+d[8], e=d[1]+d[3]+d[5]+d[7];
  const d10=((o*7 - e)%10+10)%10; if(d10!==d[9]) return false;
  const d11=d.slice(0,10).reduce((a,b)=>a+b,0)%10; return d11===d[10];
}
function yyyyFromYY(yy){ const y=+yy; return y<=24?2000+y:1900+y; }

/* ==================== MRZ Ayrıştırıcı ==================== */
function scoreMRZ(l1,l2,l3){
  let s=0;
  if(l3 && /<</.test(l3)) s+=8;
  if(l2 && /^\d{6}/.test(l2)) s+=6;
  if(l1 && /\d{11}$/.test(l1.replace(/</g,''))) s+=6;
  return s + (l1?.length||0)/10 + (l2?.length||0)/10 + (l3?.length||0)/10;
}
function parseMRZ_TR(text){
  if(!text) return null;
  const L=text.trim().split(/\n+/).map(s=>s.replace(/\s+/g,'').toUpperCase());
  const l1=L[0]||'', l2=L[1]||'', l3=L[2]||'';

  let tckn='';{
    const only=normalizeDigits(l1.replace(/</g,'')).replace(/\D/g,'');
    const m=only.match(/(\d{11})$/); if(m && isValidTCKN(m[1])) tckn=m[1];
  }
  let dogum='';{
    const six=(normalizeDigits(l2).match(/^\d{6}/)||[])[0];
    if(six){ const yy=six.slice(0,2), mm=six.slice(2,4), dd=six.slice(4,6);
      const Y=yyyyFromYY(yy), M=+mm, D=+dd;
      if(M>=1&&M<=12&&D>=1&&D<=31) dogum=`${Y}-${mm}-${dd}`; }
  }
  let ad='',soyad='';{
    if(l3.includes('<<')){ const [s,g]=l3.split('<<'); soyad=s.replace(/</g,' ').trim().replace(/\s+/g,' '); ad=(g||'').replace(/</g,' ').trim().replace(/\s+/g,' '); }
  }
  if(!(tckn||dogum||ad||soyad)) return null;
  return {tckn,dogum,ad,soyad,_score:scoreMRZ(l1,l2,l3)};
}

/* ==================== Kamera ==================== */
function preferBack(list){
  const score=d=>{ const L=(d.label||'').toLowerCase(); let s=0; if(/back|rear|environment/.test(L)) s+=5; if(/front|user/.test(L)) s-=4; if(/camera\s*0.*back/.test(L)) s+=2; return s; };
  return list.slice().sort((a,b)=>score(b)-score(a));
}
async function listCameras(){
  // İsimlerin görünmesi için bir kez izin iste
  try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch(_){ }
  let all=await navigator.mediaDevices.enumerateDevices();
  all=all.filter(d=>d.kind==='videoinput');
  devices=preferBack(all);

  const sel=$('#camera'); sel.innerHTML='';
  devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(o); });
  deviceIndex = 0;
  sel.value = String(deviceIndex);
}
async function openCamera(){
  await stopAll();
  const dev=devices[deviceIndex];
  if(!dev){ setStatus('Kamera bulunamadı.'); return false; }
  const low=$('#lowres').checked;
  const constraints={ video:{
      deviceId:{exact:dev.deviceId},
      facingMode:'environment',
      width: low?{ideal:1280}:{ideal:1920},
      height: low?{ideal:720}:{ideal:1080},
      frameRate:{ideal:30},
      advanced:[{focusMode:'continuous'}]
    }, audio:false };
  setStatus('Kamera açılıyor…');
  const v=$('#video');
  try{
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    currentStream=stream; v.srcObject=stream;
    try{ await v.play(); $('#tapOverlay').style.display='none'; }
    catch(_){ $('#tapOverlay').style.display='flex'; $('#btnTap').onclick=()=>v.play().then(()=>$('#tapOverlay').style.display='none'); }
    setStatus('Kamera açık.');
    $('#btnSnap').disabled=false;
    $('#btnStop').disabled=false;
    // seçili foto yoksa MRZ butonu kapalı kalır
    if(selectedImage) $('#btnMRZ').disabled=false;
    return true;
  }catch(e){ log('getUserMedia:', e.name, e.message); setStatus('Kamera açılamadı: '+e.message); return false; }
}
async function stopAll(){
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  currentStream=null;
  $('#btnSnap').disabled=true; $('#btnStop').disabled=true;
}

/* Kamera değişince hemen o kamerayı aç */
document.addEventListener('change', async (ev)=>{
  if(ev.target && ev.target.id==='camera'){
    deviceIndex = +ev.target.value || 0;
    if(devices[deviceIndex]){ await openCamera(); }
  }
});

/* ==================== Fotoğraf alma / yükleme ==================== */
async function takePhoto(){
  if(!currentStream) return null;
  try{
    const track=currentStream.getVideoTracks()[0];
    if('ImageCapture' in window){
      const ic=new ImageCapture(track);
      if(ic.takePhoto){ const blob=await ic.takePhoto(); return await createImageFromBlob(blob); }
      const bitmap=await ic.grabFrame();
      const c=document.createElement('canvas'); c.width=bitmap.width; c.height=bitmap.height;
      const ctx=c.getContext('2d'); ctx.drawImage(bitmap,0,0);
      const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
      return await createImageFromBlob(blob);
    }
  }catch(e){ log('takePhoto:',e); }
  const v=$('#video');
  const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight;
  const ctx=c.getContext('2d'); ctx.drawImage(v,0,0);
  const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
  return await createImageFromBlob(blob);
}
function createImageFromBlob(blob){
  return new Promise(res=>{
    const url=URL.createObjectURL(blob); const img=new Image(); img.onload=()=>{ URL.revokeObjectURL(url); res(img); }; img.src=url;
  });
}
function showPreview(img){
  selectedImage=img;
  const prev=$('#preview');
  const c=document.createElement('canvas'); const ctx=c.getContext('2d');
  const maxW=900, scale=Math.min(1, maxW/img.width);
  c.width=Math.floor(img.width*scale); c.height=Math.floor(img.height*scale);
  ctx.drawImage(img,0,0,c.width,c.height);
  prev.src=c.toDataURL('image/jpeg',0.9);
  $('#btnMRZ').disabled=false;
}

/* ==================== Görüntü işleme ==================== */
function cropMRZBandFromImage(img){
  const iw=img.width, ih=img.height, bandH=Math.floor(ih*0.34), bandY=ih - bandH;
  const scale=2;
  const c=document.createElement('canvas'), ctx=c.getContext('2d');
  c.width=Math.floor(iw*scale); c.height=Math.floor(bandH*scale);
  ctx.drawImage(img, 0, bandY, iw, bandH, 0,0, c.width, c.height);
  return c;
}
function sharpen(ctx,w,h){
  const img=ctx.getImageData(0,0,w,h), d=img.data.slice();
  const out=ctx.getImageData(0,0,w,h), o=out.data;
  const off=[-w*4,0,w*4,-4,4];
  for(let i=0;i<o.length;i+=4){
    let sum=0,cnt=0;
    for(const k of off){ const j=i+k; if(j>=0&&j<d.length){ const g=(d[j]*0.299+d[j+1]*0.587+d[j+2]*0.114)|0; sum+=g; cnt++; } }
    const center=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114)|0;
    const val=Math.min(255,Math.max(0, center*1.4 - (sum/cnt)*0.4));
    o[i]=o[i+1]=o[i+2]=val; o[i+3]=255;
  }
  ctx.putImageData(out,0,0);
}
function adaptiveMeanThreshold(ctx,w,h,block=25,C=10){
  const src=ctx.getImageData(0,0,w,h); const d=src.data;
  const gray=new Uint8ClampedArray(w*h);
  for(let i=0,j=0;i<d.length;i+=4,++j){ gray[j]=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114)|0; }
  const S=new Float64Array((w+1)*(h+1));
  for(let y=1;y<=h;y++){
    let rowSum=0; for(let x=1;x<=w;x++){
      const g=gray[(y-1)*w+(x-1)];
      rowSum+=g; const idx=y*(w+1)+x;
      S[idx]=S[(y-1)*(w+1)+x]+rowSum;
    }
  }
  const r=(block|1)>>1; const out=new Uint8ClampedArray(w*h*4);
  for(let y=0;y<h;y++){
    const y0=Math.max(0,y-r), y1=Math.min(h-1,y+r);
    for(let x=0;x<w;x++){
      const x0=Math.max(0,x-r), x1=Math.min(w-1,x+r);
      const A=(y1+1)*(w+1)+(x1+1), B=(y0)*(w+1)+(x1+1), Cc=(y1+1)*(w+1)+(x0), D=(y0)*(w+1)+(x0);
      const area=(x1-x0+1)*(y1-y0+1);
      const sum=S[A]-S[B]-S[Cc]+S[D];
      const mean=sum/area;
      const g=gray[y*w+x];
      const bw = g > (mean - C) ? 255 : 0;
      const i=(y*w+x)*4; out[i]=out[i+1]=out[i+2]=bw; out[i+3]=255;
    }
  }
  const dst=new ImageData(out,w,h); ctx.putImageData(dst,0,0);
}
function rotateToCanvas(srcCanvas, angleDeg){
  const rad=angleDeg*Math.PI/180; const cw=srcCanvas.width, ch=srcCanvas.height;
  const tmp=document.createElement('canvas'); const ctx=tmp.getContext('2d');
  tmp.width=cw; tmp.height=ch; ctx.translate(cw/2, ch/2); ctx.rotate(rad); ctx.drawImage(srcCanvas, -cw/2, -ch/2);
  return tmp;
}

/* ==================== OCR ==================== */
async function runOCR(canvas){
  if(!await loadTesseract()){ log('Tesseract yüklenemedi.'); return null; }
  setStatus('OCR çalışıyor…');
  const worker=await Tesseract.createWorker('eng');
  try{
    const {data:{text}}=await worker.recognize(canvas);
    return text;
  }finally{ await worker.terminate(); }
}

/* ==================== Ana MRZ işleme ==================== */
async function processMRZ(){
  if(!selectedImage){ setStatus('Önce bir fotoğraf seçin.'); return; }
  setStatus('MRZ işleniyor…');
  const band=cropMRZBandFromImage(selectedImage);
  const ctx=band.getContext('2d');
  sharpen(ctx,band.width,band.height);
  adaptiveMeanThreshold(ctx,band.width,band.height);

  const angles=[0,-1,1,-2,2];
  let bestResult=null, bestScore=0;
  for(const angle of angles){
    const rotated=angle===0?band:rotateToCanvas(band,angle);
    const text=await runOCR(rotated);
    if(!text) continue;
    const parsed=parseMRZ_TR(text);
    if(parsed && parsed._score>bestScore){ bestResult=parsed; bestScore=parsed._score; }
  }

  if(bestResult){
    $('#tckn').value=bestResult.tckn||'';
    $('#ad').value=bestResult.ad||'';
    $('#soyad').value=bestResult.soyad||'';
    $('#dogum').value=bestResult.dogum||'';
    $('#raw').value=JSON.stringify(bestResult,null,2);
    setStatus('MRZ başarıyla okundu.');
  }else{
    setStatus('MRZ okunamadı. Fotoğrafı yeniden çekin.');
  }
}

/* ==================== Kaydetme ==================== */
function saveRecord(){
  const tckn=$('#tckn').value.trim();
  const ad=$('#ad').value.trim();
  const soyad=$('#soyad').value.trim();
  const dogum=$('#dogum').value.trim();
  const telefon=$('#telefon').value.trim();
  
  if(!tckn && !ad && !soyad){ setStatus('En az TCKN, ad veya soyad doldurulmalı.'); return; }
  
  const record={tckn,ad,soyad,dogum,telefon,timestamp:Date.now()};
  const list=loadRecords();
  list.push(record);
  saveRecords(list);
  
  // Ayrı HTML sayfasına veri gönder
  sendToDisplayPage(record);
  
  setStatus('Kayıt eklendi.');
  
  // Formu temizle
  $('#tckn').value='';
  $('#ad').value='';
  $('#soyad').value='';
  $('#dogum').value='';
  $('#telefon').value='';
  $('#raw').value='';
}

/* ==================== Ayrı HTML sayfasına veri gönderme ==================== */
function sendToDisplayPage(record) {
  // Offline/online durumunu kontrol et
  if (navigator.onLine) {
    // Online ise direkt gönder
    sendDataToServer(record);
  } else {
    // Offline ise yerel olarak sakla
    storeOfflineData(record);
  }
}

function sendDataToServer(record) {
  // Burada gerçek bir server endpoint'ine POST isteği gönderilecek
  // Şimdilik localStorage'a kaydediyoruz
  const sharedData = JSON.parse(localStorage.getItem('shared_records') || '[]');
  sharedData.push(record);
  localStorage.setItem('shared_records', JSON.stringify(sharedData));
}

function storeOfflineData(record) {
  const offlineData = JSON.parse(localStorage.getItem('offline_records') || '[]');
  offlineData.push(record);
  localStorage.setItem('offline_records', JSON.stringify(offlineData));
}

function syncOfflineData() {
  const offlineData = JSON.parse(localStorage.getItem('offline_records') || '[]');
  if (offlineData.length > 0 && navigator.onLine) {
    offlineData.forEach(record => sendDataToServer(record));
    localStorage.removeItem('offline_records');
    log('Offline veriler senkronize edildi:', offlineData.length, 'kayıt');
  }
}

// Online/offline durumu değiştiğinde senkronize et
window.addEventListener('online', syncOfflineData);

/* ==================== Dışa aktarma ==================== */
function exportTXT(){
  const list=loadRecords();
  if(!list.length){ setStatus('Dışa aktarılacak kayıt yok.'); return; }
  let txt='TC Kimlik Kayıtları\n' + '='.repeat(50) + '\n\n';
  list.forEach((r,i)=>{
    txt+=`${i+1}. Kayıt:\n`;
    txt+=`TCKN: ${r.tckn||'—'}\n`;
    txt+=`Ad: ${r.ad||'—'}\n`;
    txt+=`Soyad: ${r.soyad||'—'}\n`;
    txt+=`Doğum: ${r.dogum||'—'}\n`;
    txt+=`Telefon: ${r.telefon||'—'}\n`;
    txt+=`Tarih: ${r.timestamp?new Date(r.timestamp).toLocaleString('tr-TR'):'—'}\n\n`;
  });
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='tc_kayitlari.txt'; a.click();
  URL.revokeObjectURL(url);
  setStatus('TXT dosyası indirildi.');
}

/* ==================== Event Listeners ==================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await listCameras();
  
  $('#btnOpen').onclick=openCamera;
  $('#btnSnap').onclick=async ()=>{ const img=await takePhoto(); if(img) showPreview(img); };
  $('#btnUpload').onclick=()=>$('#file').click();
  $('#file').onchange=ev=>{ const f=ev.target.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.onload=()=>showPreview(img); img.src=e.target.result; }; r.readAsDataURL(f); } };
  $('#btnMRZ').onclick=processMRZ;
  $('#btnStop').onclick=stopAll;
  $('#btnSave').onclick=saveRecord;
  $('#btnExport').onclick=exportTXT;
  $('#btnClear').onclick=()=>{ if(confirm('Tüm kayıtları silmek istediğinizden emin misiniz?')){ saveRecords([]); setStatus('Tüm kayıtlar silindi.'); } };
  
  // Sayfa yüklendiğinde offline verileri senkronize et
  syncOfflineData();
});
</script>
</body>
</html>


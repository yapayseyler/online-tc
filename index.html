<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Online TC — Kamera + Barkod/MRZ (CDN Fallback + Yerel)</title>
<style>
  :root{--bg:#0f1115;--card:#171923;--ink:#e8e8ea;--muted:#9aa0a6;--acc:#4f8cff;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:14px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 30px rgb(0 0 0/.25);padding:14px;margin:12px 0}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:var(--acc);color:#fff;font-weight:600}
  button.secondary{background:#2a2e3a} button.danger{background:#e54848}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{font-size:13px;color:var(--muted)}
  select,input[type="checkbox"]{padding:8px;border-radius:8px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  .video-wrap{position:relative;border:1px solid #2b2f3a;border-radius:12px;overflow:hidden}
  video{width:100%;max-height:55vh;background:#000}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
  .overlay button{background:#000;border:1px solid #444}
  .scanline{position:absolute;left:0;right:0;top:45%;height:2px;background:rgba(79,140,255,.9);box-shadow:0 0 14px rgba(79,140,255,.9);animation:scan 2.2s linear infinite;display:none}
  @keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}
  pre{white-space:pre-wrap;background:#0e1016;border:1px solid #2b2f3a;padding:12px;border-radius:12px;max-height:32vh;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .value{display:flex;gap:8px;align-items:center}
  .value input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#2a2e3a;color:#cbd5e1;border:1px solid #333}
  .badge.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#bbf7d0}
  .badge.warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#fde68a}
  .badge.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
  .tiny{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Online TC — Barkod & MRZ Okuyucu</h1>
    <div class="row" style="margin-top:6px">
      <button id="btnOpen">Kamerayı Aç</button>
      <button id="btnBarcode" class="secondary" disabled>Barkod Tara</button>
      <button id="btnMRZ" class="secondary" disabled>MRZ Tara</button>
      <button id="btnStop" class="secondary" disabled>Durdur</button>
      <span id="status" style="color:#cbd5e1">Hazır.</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <label>Kamera</label>
      <select id="camera"></select>
      <label><input type="checkbox" id="lowres"> Düşük çözünürlük (1280×720)</label>
    </div>
    <div class="video-wrap" id="videoWrap">
      <video id="video" autoplay playsinline muted></video>
      <div class="overlay" id="tapOverlay"><button id="btnTap">Videoyu Başlat</button></div>
      <div class="scanline" id="scanline"></div>
    </div>
  </div>

  <div class="card">
    <label>Ham veri / Sonuç</label>
    <textarea id="raw" rows="4" spellcheck="false"></textarea>
    <div class="actions">
      <button id="btnParse" class="secondary">Veriyi Ayıkla</button>
      <span class="tiny">Taranınca otomatik ayıklanır. Gerekirse bu butona tıklayın.</span>
    </div>
  </div>

  <div class="card" id="resultCard">
    <h2 style="margin:0 0 8px;font-size:18px">Ayıklanmış Alanlar</h2>
    <div class="grid">
      <div class="field">
        <label>Ad</label>
        <div class="value">
          <input id="firstName" placeholder="—" />
          <span id="firstNameBadge" class="badge">-</span>
        </div>
      </div>
      <div class="field">
        <label>Soyad</label>
        <div class="value">
          <input id="lastName" placeholder="—" />
          <span id="lastNameBadge" class="badge">-</span>
        </div>
      </div>
      <div class="field">
        <label>Doğum Tarihi</label>
        <div class="value">
          <input id="birthDate" placeholder="YYYY-MM-DD" />
          <span id="birthBadge" class="badge">-</span>
        </div>
      </div>
      <div class="field">
        <label>T.C. Kimlik No</label>
        <div class="value">
          <input id="tckn" placeholder="11 haneli" />
          <span id="tcknBadge" class="badge">-</span>
        </div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button id="btnCopyJSON" class="secondary">JSON Kopyala</button>
      <button id="btnClear" class="danger">Temizle</button>
      <span id="parseNote" class="tiny"></span>
    </div>
  </div>

  <div class="card">
    <details open>
      <summary style="cursor:pointer">Teşhis Günlüğü</summary>
      <pre id="log"></pre>
    </details>
  </div>
</div>

<script>
/* ========== Yardımcılar ========== */
const $ = s=>document.querySelector(s);
const log = (...a)=>{ const t=a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' '); $('#log').textContent += t + "\n"; console.log(...a); };
const setStatus = t => $('#status').textContent = t;
const showScanline = b => $('#scanline').style.display = b ? 'block' : 'none';
window.onerror = (m,s,l,c,e)=>{ log('window.onerror:', m, s+':'+l, e && (e.stack||e)); };
window.onunhandledrejection = ev=>{ log('unhandledrejection:', ev.reason && (ev.reason.stack||ev.reason)); };

/* ========== Dinamik script yükleyici (çoklu CDN + yerel) ========== */
async function loadScriptTry(urls){
  for(const url of urls){
    try{
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true;
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error('Script hata:'+url));
        document.head.appendChild(s);
      });
      log('Yüklendi:', url);
      return true;
    }catch(e){
      log('CDN denemesi başarısız:', url);
    }
  }
  return false;
}

async function loadZXing(){
  if(window.ZXingBrowser) return true;
  const ok = await loadScriptTry([
    'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/umd/index.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/zxing/0.1.4/index.min.js',
    'https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js',
    '/vendor/zxing-browser-0.1.4.min.js'
  ]);
  return !!window.ZXingBrowser && ok;
}
async function loadTesseract(){
  if(window.Tesseract) return true;
  const ok = await loadScriptTry([
    'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js',
    'https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js',
    '/vendor/tesseract-4.0.2.min.js'
  ]);
  return !!window.Tesseract && ok;
}

/* ========== Durum ========== */
let devices=[], deviceIndex=0, currentStream=null, currentMode=null; // 'barcode' | 'mrz'
let scanTimer=null, codeReader=null;

/* ========== Kamera listesi ========== */
function preferBack(list){
  const score = d=>{
    const L=(d.label||'').toLowerCase();
    let s=0;
    if(/back|rear|environment/.test(L)) s+=5;
    if(/front|user/.test(L)) s-=4;
    if(/ultra[-\s]?wide|wide/.test(L)) s-=2;
    if(/tele|macro|3x|5x/.test(L)) s+=1;
    if(/camera\s*0.*back/.test(L)) s+=2;
    return s;
  };
  return list.slice().sort((a,b)=>score(b)-score(a));
}
async function listCameras(){
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    tmp.getTracks().forEach(t=>t.stop());
  }catch(_){}
  let all = await navigator.mediaDevices.enumerateDevices();
  all = all.filter(d=>d.kind==='videoinput');
  devices = preferBack(all);
  const sel = $('#camera'); sel.innerHTML='';
  devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(o); });
  deviceIndex=0; sel.value='0';
  log('Kameralar:', devices);
}

/* ========== Video oynatma güvencesi ========== */
function waitForFirstFrame(video){
  return new Promise(resolve=>{
    if(video.readyState>=2 && video.videoWidth>0){ return resolve(); }
    let done=false;
    const settle=()=>{ if(!done && video.videoWidth>0){ done=true; resolve(); } };
    video.addEventListener('canplay', ()=>settle(), {once:true});
    if('requestVideoFrameCallback' in video){
      video.requestVideoFrameCallback(()=>settle());
    }else{
      const iv=setInterval(()=>{ if(done) return clearInterval(iv); if(video.videoWidth>0){ clearInterval(iv); settle(); } }, 50);
    }
    setTimeout(()=>settle(), 3000);
  });
}
async function tryPlay(video){
  try{
    video.muted=true; video.setAttribute('muted',''); video.setAttribute('playsinline','');
    await video.play();
    $('#tapOverlay').style.display='none';
    return true;
  }catch(e){
    log('video.play reddedildi:', e.name, e.message);
    $('#tapOverlay').style.display='flex';
    return new Promise(res=>{
      $('#btnTap').onclick = async ()=>{
        try{ await video.play(); $('#tapOverlay').style.display='none'; res(true); }
        catch(e2){ log('tap play hata:', e2.name, e2.message); res(false); }
      };
    });
  }
}

/* ========== Akış kontrolü ========== */
async function stopAll(){
  showScanline(false);
  if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
  if(codeReader){ try{ await codeReader.reset(); }catch(_){ } codeReader=null; }
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  currentStream=null; currentMode=null;
  $('#btnBarcode').disabled=true; $('#btnMRZ').disabled=true; $('#btnStop').disabled=true;
}

async function openCamera(){
  await stopAll();
  const dev = devices[deviceIndex];
  if(!dev){ setStatus('Kamera bulunamadı.'); return false; }
  const low = $('#lowres').checked;
  const constraints = {
    video: {
      deviceId: { exact: dev.deviceId },
      facingMode: 'environment',
      width: low ? {ideal:1280} : {ideal:1920},
      height: low ? {ideal:720} : {ideal:1080},
      frameRate: { ideal: 30 },
      advanced: [{ focusMode:'continuous' }]
    },
    audio:false
  };
  setStatus('Kamera açılıyor…');
  const v = $('#video');
  try{
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    v.srcObject = stream;

    const played = await tryPlay(v);
    if(!played){ setStatus('Videoyu başlatmak için butona dokunun.'); return false; }

    await waitForFirstFrame(v);
    setStatus('Kamera açık.');
    $('#btnBarcode').disabled=false; $('#btnMRZ').disabled=false; $('#btnStop').disabled=false;
    return true;
  }catch(e){
    log('getUserMedia hata:', e.name, e.message);
    if(e.name==='NotAllowedError') setStatus('Kamera izni verilmedi.');
    else if(e.name==='NotReadableError') setStatus('Kamera başka uygulama tarafından kullanılıyor olabilir.');
    else setStatus('Kamera açılamadı: '+e.message);
    return false;
  }
}

/* ========== Barkod ========== */
async function startBarcode(){
  if(!currentStream){ const ok = await openCamera(); if(!ok) return; }
  const okLib = await loadZXing();
  if(!okLib){ setStatus('Barkod kütüphanesi yüklenemedi (ağ engeli?). /vendor/ yolunu kurabilirsiniz.'); return; }
  currentMode='barcode';
  showScanline(true);
  setStatus('Barkod taranıyor…');

  const hints = new Map();
  const BF = ZXingBrowser.BarcodeFormat;
  hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS,[BF.PDF_417,BF.QR_CODE,BF.CODE_128]);
  codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);

  setTimeout(()=> {
    try{
      codeReader.decodeFromVideoElementContinuously($('#video'), (res, err)=>{
        if(res){
          showScanline(false);
          setStatus('Barkod okundu.');
          const text = res.getText();
          $('#raw').value = text;
          parseAndFill(text, {source:'barcode'});
        }
      });
    }catch(e){ log('ZXing start hata:', e); setStatus('Barkod okuyucu hatası: '+e.message); }
  }, 300);
}

/* ========== MRZ ========== */
async function startMRZ(){
  if(!currentStream){ const ok = await openCamera(); if(!ok) return; }
  const okLib = await loadTesseract();
  if(!okLib){ setStatus('Tesseract yüklenemedi (ağ engeli). /vendor/ yolunu kurarsanız MRZ çalışır.'); return; }

  currentMode='mrz';
  showScanline(true);
  setStatus('MRZ taranıyor…');
  const v=$('#video');
  const c=document.createElement('canvas'), ctx=c.getContext('2d');

  setTimeout(()=>{
    scanTimer=setInterval(async()=>{
      if(currentMode!=='mrz'||!v.videoWidth) return;
      const vw=v.videoWidth, vh=v.videoHeight;
      const h=Math.floor(vh*0.28), y=vh-h, scale=2;
      c.width=vw*scale; c.height=h*scale;
      ctx.drawImage(v,0,y,vw,h, 0,0,c.width,c.height);

      // basit gri + eşik
      const img=ctx.getImageData(0,0,c.width,c.height), d=img.data;
      for(let i=0;i<d.length;i+=4){
        const g=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
        const bw=g>140?255:0; d[i]=d[i+1]=d[i+2]=bw;
      }
      ctx.putImageData(img,0,0);

      try{
        const {data:{text}} = await Tesseract.recognize(c,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'});
        const cleaned = text.toUpperCase().replace(/[^\w<\n]/g,'');
        if(cleaned.replace(/\s/g,'').length>20){
          showScanline(false);
          setStatus('MRZ okundu.');
          $('#raw').value = cleaned;
          parseAndFill(cleaned, {source:'mrz'});
        }else{
          setStatus('MRZ bekleniyor… Netlik/zoom deneyin.');
        }
      }catch(e){ log('OCR err:', e.name, e.message); setStatus('OCR hatası: '+e.message); }
    }, 1500);
  }, 300);
}

/* ========== TCKN doğrulama ========== */
function isValidTCKN(n){
  const s=(n||'').replace(/\D/g,'');
  if(s.length!==11 || s[0]==='0') return false;
  const d=s.split('').map(x=>+x);
  const odd = d[0]+d[2]+d[4]+d[6]+d[8];
  const even = d[1]+d[3]+d[5]+d[7];
  const d10 = ((odd*7 - even) % 10 + 10) % 10;
  if(d[9]!==d10) return false;
  const d11 = (d.slice(0,10).reduce((a,b)=>a+b,0)) % 10;
  return d[10]===d11;
}

/* ========== Tarih yardımcıları ========== */
function toISODate(y,m,d){
  const pad=n=>String(n).padStart(2,'0');
  try{
    const dt = new Date(Date.UTC(y, m-1, d));
    if(dt.getUTCFullYear()!==y || (dt.getUTCMonth()+1)!==m || dt.getUTCDate()!==d) return null;
    return `${y}-${pad(m)}-${pad(d)}`;
  }catch{ return null; }
}
function fromYYMMDD(yy,mm,dd){
  const y = +yy, m=+mm, d=+dd;
  if(m<1||m>12||d<1||d>31) return null;
  const now = new Date();
  const curY = now.getUTCFullYear()%100;
  const century = (y<=curY ? 2000 : 1900);
  return toISODate(century+y,m,d);
}

/* ========== İsim ayıklama (MRZ ve metin) ========== */
function parseNamesFromMRZ(lines){
  // TD1 formatında isimler çoğunlukla 3. satırda: SOYAD<<AD(AD2)
  const nameLine = lines.find(l=>l.includes('<<')) || '';
  if(!nameLine) return {};
  const cleaned = nameLine.replace(/[^A-Z<]/g,'');
  const parts = cleaned.split('<<');
  const surname = (parts[0]||'').replace(/<+/g,' ').trim();
  const givenRaw = (parts[1]||'').split('<').filter(Boolean).join(' ').trim();
  return { firstName: givenRaw || undefined, lastName: surname || undefined };
}
function parseNamesFromLabeled(text){
  // ADI: XXX  SOYADI: YYY / NAME: / SURNAME:
  const t = ' ' + text.replace(/\s+/g,' ') + ' ';
  const m1 = t.match(/(?:AD|ADI)\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+?)\s+(?:SOYAD[İI]|SOYADI)\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+)/i);
  if(m1) return { firstName: m1[1].trim(), lastName: m1[2].trim() };
  const m2 = t.match(/SURNAME\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+?)\s+GIVEN\s*NAMES?\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+)/i);
  if(m2) return { lastName: m2[1].trim(), firstName: m2[2].trim() };
  const m3 = t.match(/NAME\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+?)\s+SURNAME\s*[:\-]?\s*([A-ZÇĞİÖŞÜ\s]+)/i);
  if(m3) return { firstName: m3[1].trim(), lastName: m3[2].trim() };
  return {};
}

/* ========== Doğum tarihi ayıklama ========== */
function parseBirthFromText(text){
  const t = text.toUpperCase();
  // 1) Etiketli DD.MM.YYYY / YYYY-MM-DD / DD/MM/YYYY
  const r1 = t.match(/(DO[ĞG]UM\s*TAR[İI]H[İI]|DOB|BIRTH)\D{0,10}(\d{2}[.\-\/]\d{2}[.\-\/]\d{4}|\d{4}[.\-\/]\d{2}[.\-\/]\d{2})/);
  if(r1){
    const ds=r1[2].match(/\d+/g).map(x=>+x);
    let y,m,d;
    if(String(r1[2]).startsWith('19')||String(r1[2]).startsWith('20')){ y=ds[0]; m=ds[1]; d=ds[2]; }
    else { d=ds[0]; m=ds[1]; y=ds[2]; }
    const iso=toISODate(y,m,d); if(iso) return iso;
  }
  // 2) Düz biçimler: DD.MM.YYYY | YYYY/MM/DD
  const r2 = t.match(/\b(\d{4})[.\-\/](\d{2})[.\-\/](\d{2})\b/);
  if(r2){ const iso=toISODate(+r2[1],+r2[2],+r2[3]); if(iso) return iso; }
  const r3 = t.match(/\b(\d{2})[.\-\/](\d{2})[.\-\/](\d{4})\b/);
  if(r3){ const iso=toISODate(+r3[3],+r3[2],+r3[1]); if(iso) return iso; }
  return null;
}
function parseBirthFromMRZ(lines){
  // TD1 satır-2: YYMMDD + checkdigit
  const l2 = lines[1]||'';
  const m = l2.match(/(^|[^0-9])(\d{2})(\d{2})(\d{2})[0-9]/); // check digit'i tüketmeden
  if(m){
    const iso = fromYYMMDD(m[2],m[3],m[4]);
    if(iso) return iso;
  }
  // Alternatif: herhangi bir 6 hane + check digit
  const any = lines.join('\n').match(/(\d{2})(\d{2})(\d{2})[0-9]/);
  if(any){
    const iso = fromYYMMDD(any[1],any[2],any[3]);
    if(iso) return iso;
  }
  return null;
}

/* ========== TCKN ayıklama ========== */
function parseTCKN(text){
  // Etiketli olabilir: TCKN, KİMLİK NO, IDNO vs. Önce etiketli ara
  const label = text.toUpperCase().match(/(TC\s*K[İI]ML[İI]K\s*NO|TCKN|ID\s*NO|IDENTIFICATION)\D{0,10}(\d{11})/);
  if(label && isValidTCKN(label[2])) return label[2];
  // Değilse: 11 haneli tüm adayları tara, geçerli ilkini al
  const cands = text.replace(/[^\d]/g,' ').split(/\s+/).filter(x=>x.length===11);
  for(const c of cands){ if(isValidTCKN(c)) return c; }
  return null;
}

/* ========== Genel ayrıştırma ========== */
function parseAll(raw){
  const res = { firstName:null, lastName:null, birthDate:null, tckn:null, hints:[] };
  if(!raw) return res;

  const t = raw.replace(/\r/g,'').trim();
  const upper = t.toUpperCase();
  const lines = upper.split('\n').map(x=>x.trim()).filter(Boolean);

  // MRZ mi? (çok < karakteri ve 2-3 satır tipik)
  const isLikelyMRZ = lines.length<=5 && (upper.match(/</g)||[]).length>10;

  // İsimler
  let names={};
  if(isLikelyMRZ) { names = parseNamesFromMRZ(lines); if(Object.keys(names).length) res.hints.push('MRZ ad/soyad'); }
  if(!names.firstName || !names.lastName){
    const n2 = parseNamesFromLabeled(upper);
    if(n2.firstName||n2.lastName){ names = {...names, ...n2}; res.hints.push('Labeled ad/soyad'); }
  }

  res.firstName = names.firstName || null;
  res.lastName  = names.lastName  || null;

  // Doğum tarihi
  let dob = null;
  if(isLikelyMRZ){ dob = parseBirthFromMRZ(lines); if(dob) res.hints.push('MRZ DOB'); }
  if(!dob){ dob = parseBirthFromText(upper); if(dob) res.hints.push('Metin DOB'); }
  res.birthDate = dob;

  // TCKN
  const tckn = parseTCKN(upper);
  if(tckn){ res.tckn = tckn; res.hints.push('TCKN checksum ok'); }

  return res;
}

/* ========== UI doldurma + rozetler ========== */
function setBadge(el, state, msgOk='Geçerli'){
  el.className = 'badge';
  if(state==='ok') { el.classList.add('ok'); el.textContent=msgOk; }
  else if(state==='warn') { el.classList.add('warn'); el.textContent='Eksik'; }
  else if(state==='bad') { el.classList.add('bad'); el.textContent='Geçersiz'; }
  else { el.textContent='-'; }
}
function fillFields(data){
  $('#firstName').value = data.firstName||'';
  $('#lastName').value  = data.lastName||'';
  $('#birthDate').value = data.birthDate||'';
  $('#tckn').value      = data.tckn||'';

  // Validasyonlar
  setBadge($('#firstNameBadge'), data.firstName ? 'ok' : 'warn');
  setBadge($('#lastNameBadge'),  data.lastName  ? 'ok' : 'warn');

  // Doğum tarihi makul mü (1900-2100 arası)
  let birthState='warn';
  if(data.birthDate){
    const m = data.birthDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m){
      const y=+m[1]; if(y>=1900 && y<=2100) birthState='ok';
      else birthState='bad';
    }else birthState='bad';
  }
  setBadge($('#birthBadge'), birthState);

  setBadge($('#tcknBadge'), data.tckn ? (isValidTCKN(data.tckn)?'ok':'bad') : 'warn', 'Doğrulandı');
  $('#parseNote').textContent = data.hints?.length ? `Kaynak: ${data.hints.join(', ')}` : '';
}

/* ========== Kopyalama / Temizleme ========== */
function currentJSON(){
  return JSON.stringify({
    firstName: $('#firstName').value.trim() || null,
    lastName : $('#lastName').value.trim()  || null,
    birthDate: $('#birthDate').value.trim() || null,
    tckn     : $('#tckn').value.trim()      || null
  }, null, 2);
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); setStatus('Panoya kopyalandı.'); }
  catch{ setStatus('Kopyalama izni verilmedi.'); }
}

/* ========== Ham metin değişirse ========== */
function parseAndFill(text, meta={}){
  const data = parseAll(text||'');
  fillFields(data);
  if(meta.source){ log('Ayrıştırma kaynağı:', meta.source, data); }
}

/* ========== Eventler ========== */
$('#btnOpen').addEventListener('click', async ()=>{
  try{ await listCameras(); const ok = await openCamera(); if(!ok) return; }catch(e){ log('btnOpen hata:', e.name, e.message); }
});
$('#btnStop').addEventListener('click', async ()=>{ await stopAll(); setStatus('Durduruldu.'); });
$('#btnBarcode').addEventListener('click', async ()=>{ try{ await startBarcode(); }catch(e){ log('startBarcode hata:', e.name, e.message); } });
$('#btnMRZ').addEventListener('click', async ()=>{ try{ await startMRZ(); }catch(e){ log('startMRZ hata:', e.name, e.message); } });
$('#camera').addEventListener('change', async ()=>{ deviceIndex=+$('#camera').value; if(currentStream){ await openCamera(); } });

$('#raw').addEventListener('input', ()=> parseAndFill($('#raw').value, {source:'manual'}));
$('#btnParse').addEventListener('click', ()=> parseAndFill($('#raw').value, {source:'manual-click'}));
$('#btnCopyJSON').addEventListener('click', ()=> copyText(currentJSON()));
$('#btnClear').addEventListener('click', ()=>{
  $('#raw').value=''; parseAndFill('');
  $('#firstName').value=''; $('#lastName').value=''; $('#birthDate').value=''; $('#tckn').value='';
  setBadge($('#firstNameBadge')); setBadge($('#lastNameBadge')); setBadge($('#birthBadge')); setBadge($('#tcknBadge'));
  $('#parseNote').textContent='';
  setStatus('Temizlendi.');
});

/* sayfa açılışında sadece kameraları listele (akış açılmaz) */
(async()=>{ try{ await listCameras(); }catch(e){ log('listeleme hata:', e.name, e.message); } })();
</script>
</body>
</html>

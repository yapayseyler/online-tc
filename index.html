<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Online TC — Hızlı MRZ (Stabil) + Vendor ZXing + Kayıt/TXT</title>
<style>
  :root{--bg:#0f1115;--card:#171923;--ink:#e8e8ea;--muted:#9aa0a6;--acc:#4f8cff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:14px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 30px rgb(0 0 0/.25);padding:14px;margin:12px 0}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:var(--acc);color:#fff;font-weight:600}
  button.secondary{background:#2a2e3a} button.danger{background:#e54848}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{font-size:13px;color:var(--muted)}
  select,input[type="checkbox"]{padding:8px;border-radius:8px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2b2f3a;background:#0e1016;color:var(--ink)}
  textarea{min-height:90px}
  .video-wrap{position:relative;border:1px solid #2b2f3a;border-radius:12px;overflow:hidden}
  video{width:100%;max-height:55vh;background:#000}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
  .overlay button{background:#000;border:1px solid #444}
  .scanline{position:absolute;left:0;right:0;top:45%;height:2px;background:rgba(79,140,255,.9);box-shadow:0 0 14px rgba(79,140,255,.9);animation:scan 2.2s linear infinite;display:none}
  @keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}
  pre{white-space:pre-wrap;background:#0e1016;border:1px solid #2b2f3a;padding:12px;border-radius:12px;max-height:32vh;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:700px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2b2f3a;font-size:14px;word-break:break-word}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202431;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <!-- ÜST KONTROLLER -->
  <div class="card">
    <h1>Online TC — Barkod & MRZ Okuyucu <span class="pill">Stabil MRZ</span></h1>
    <div class="row" style="margin-top:6px">
      <button id="btnOpen">Kamerayı Aç</button>
      <button id="btnBarcode" class="secondary" disabled>Barkod Tara</button>
      <button id="btnMRZ" class="secondary" disabled>MRZ Tara</button>
      <button id="btnStop" class="secondary" disabled>Durdur</button>
      <button id="btnExport" class="secondary" disabled>TXT dışa aktar</button>
      <button id="btnClear" class="danger" disabled>Tüm kayıtları sil</button>
      <span id="status" style="color:#cbd5e1">Hazır.</span>
    </div>
  </div>

  <!-- KAMERA / VİDEO -->
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <label>Kamera</label>
      <select id="camera"></select>
      <label><input type="checkbox" id="lowres"> Düşük çözünürlük (1280×720)</label>
    </div>
    <div class="video-wrap" id="videoWrap">
      <video id="video" autoplay playsinline muted></video>
      <div class="overlay" id="tapOverlay"><button id="btnTap">Videoyu Başlat</button></div>
      <div class="scanline" id="scanline"></div>
    </div>
  </div>

  <!-- SONUÇ / DÜZENLE -->
  <div class="card">
    <h1>Sonuç / Düzenle</h1>
    <div class="grid" style="margin-top:8px">
      <div>
        <label>TC Kimlik No (varsa)</label>
        <input id="tckn" placeholder="11 haneli" />
      </div>
      <div>
        <label>Ad</label>
        <input id="ad" />
      </div>
      <div>
        <label>Soyad</label>
        <input id="soyad" />
      </div>
      <div>
        <label>Doğum Tarihi (YYYY-MM-DD)</label>
        <input id="dogum" placeholder="1990-01-31" />
      </div>
    </div>
    <label style="margin-top:10px;display:block">Ham veri (okunan metin)</label>
    <textarea id="raw" rows="4" spellcheck="false"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnSave">Kaydet</button>
      <span class="muted">Kaydetmeden önce bilgileri kontrol edip düzeltebilirsiniz.</span>
    </div>
  </div>

  <!-- KAYIT TABLOSU -->
  <div class="card">
    <h1>Kayıtlar</h1>
    <div class="muted" style="margin-bottom:6px">Veriler cihazınızda (localStorage) tutulur.</div>
    <table id="tbl">
      <thead>
        <tr><th>#</th><th>TCKN</th><th>Ad</th><th>Soyad</th><th>Doğum</th><th>Sil</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TEŞHİS GÜNLÜĞÜ -->
  <div class="card">
    <details>
      <summary style="cursor:pointer">Teşhis Günlüğü</summary>
      <pre id="log"></pre>
    </details>
  </div>
</div>

<script>
/* ==================== Yardımcılar / Log ==================== */
const $ = s=>document.querySelector(s);
const log = (...a)=>{ const t=a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' '); $('#log').textContent += t + "\n"; console.log(...a); };
const setStatus = t => $('#status').textContent = t;
const showScanline = b => $('#scanline').style.display = b ? 'block' : 'none';
window.onerror = (m,s,l,c,e)=>{ log('window.onerror:', m, s+':'+l, e && (e.stack||e)); };
window.onunhandledrejection = ev=>{ log('unhandledrejection:', ev.reason && (ev.reason.stack||ev.reason)); };

/* ==================== KÜTÜPHANELER ==================== */
/* Barkod: sadece vendor/yerel dosya */
async function loadZXingVendorOnly(){
  if(window.ZXingBrowser) return true;
  const localCandidates = [
    './zxing-browser-0.1.4.min.js',
    './zxing-browser.min.js',
    './zxing.min.js',
    '/vendor/zxing-browser-0.1.4.min.js',
    '/vendor/zxing-browser.min.js'
  ];
  for(const url of localCandidates){
    try{
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src=url; s.async=true;
        s.onload=()=>resolve(); s.onerror=()=>reject();
        document.head.appendChild(s);
      });
      log('ZXing vendor yüklendi:', url);
      if(window.ZXingBrowser) return true;
    }catch(_){ log('ZXing vendor bulunamadı:', url); }
  }
  return false;
}

/* MRZ için Tesseract: CDN→vendor fallback (worker reuse) */
async function loadTesseract(){
  if(window.Tesseract) return true;
  const urls = [
    'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js',
    'https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js',
    '/vendor/tesseract-4.0.2.min.js'
  ];
  for(const url of urls){
    try{
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src=url; s.async=true;
        s.onload=()=>resolve(); s.onerror=()=>reject();
        document.head.appendChild(s);
      });
      log('Tesseract yüklendi:', url);
      return true;
    }catch(_){ log('Tesseract denemesi başarısız:', url); }
  }
  return false;
}

/* ==================== Durum / Global ==================== */
let devices=[], deviceIndex=0, currentStream=null, currentMode=null; // 'barcode' | 'mrz'
let scanTimer=null, codeReader=null;
const storeKey = 'tcid_records_v1';

/* Tesseract worker (tek işçi, tekrar kullan) */
let mrzWorker=null, mrzBusy=false;

/* Stabilizasyon belleği */
const stabWin = { // son N frame
  N: 5,
  l1: [],
  l2: [],
  l3: []
};
function pushStab(key, val){
  if(!val) return;
  const arr = stabWin[key];
  arr.push(val);
  if(arr.length>stabWin.N) arr.shift();
}
function majority(arr){
  const map=new Map();
  arr.forEach(s=>map.set(s,(map.get(s)||0)+1));
  let best='', cnt=0;
  for(const [s,c] of map.entries()){
    if(c>cnt || (c===cnt && s.length>best.length)){ best=s; cnt=c; }
  }
  return best;
}

/* ==================== Kayıt Deposu ==================== */
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch(_){ return []; } }
function saveRecords(list){ localStorage.setItem(storeKey, JSON.stringify(list||[])); renderTable(); toggleExportButtons(); }
function renderTable(){
  const tbody = document.querySelector('#tbl tbody');
  const list = loadRecords();
  tbody.innerHTML = '';
  list.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.tckn||''}</td>
      <td>${r.ad||''}</td>
      <td>${r.soyad||''}</td>
      <td>${r.dogum||''}</td>
      <td><button class="danger" data-i="${i}">Sil</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = () => {
      const i = +b.dataset.i;
      const list = loadRecords();
      list.splice(i,1);
      saveRecords(list);
    };
  });
}
function toggleExportButtons(){
  const any = loadRecords().length>0;
  $('#btnExport').disabled = !any;
  $('#btnClear').disabled = !any;
}
renderTable(); toggleExportButtons();

/* ==================== Yardımcı Doğrulamalar ==================== */
function normalizeDigits(s){
  if(!s) return s;
  return s
    .replace(/O/g,'0').replace(/D/g,'0')
    .replace(/I/g,'1').replace(/L/g,'1')
    .replace(/Z/g,'2')
    .replace(/S/g,'5')
    .replace(/B/g,'8')
    .replace(/G/g,'6');
}
function isValidDateYYYYMMDD(yy,mm,dd){
  const year = +yy <= 24 ? (2000 + +yy) : (1900 + +yy);
  const m = +mm, d = +dd;
  if(m<1||m>12||d<1||d>31) return null;
  const dateStr = `${year}-${mm}-${dd}`;
  const dt = new Date(dateStr);
  if(isNaN(dt.getTime())) return null;
  if(dt.getFullYear()!==year || (dt.getMonth()+1)!==m || dt.getDate()!==d) return null;
  return dateStr;
}
function isValidTCKN(num){
  if(!/^\d{11}$/.test(num)) return false;
  if(num[0]==='0') return false;
  const digits = num.split('').map(n=>+n);
  const oddSum = digits[0]+digits[2]+digits[4]+digits[6]+digits[8];
  const evenSum = digits[1]+digits[3]+digits[5]+digits[7];
  const d10 = ((oddSum*7 - evenSum) % 10 + 10) % 10;
  if(d10 !== digits[9]) return false;
  const d11 = (digits.slice(0,10).reduce((a,b)=>a+b,0)) % 10;
  if(d11 !== digits[10]) return false;
  return true;
}

/* ==================== MRZ / Barkod Ayrıştırıcılar ==================== */
function extractTCKNAnywhere(text){
  const m = (text||'').replace(/\D/g,'').match(/(\d{11})/);
  if(!m) return '';
  const cand = m[1];
  return isValidTCKN(cand) ? cand : '';
}

/* MRZ parse + skorlayıcı */
function scoreMRZ(l1,l2,l3){
  let score = 0;
  if(l3 && l3.includes('<<')) score += 8;
  if(l2 && /^\d{6}/.test(l2)) score += 6;
  if(l1 && /\d{11}$/.test(l1.replace(/</g,''))) score += 6;
  if(l1 && l1.length>20) score += 2;
  if(l2 && l2.length>10) score += 2;
  if(l3 && l3.length>10) score += 2;
  return score;
}
/* metin → obj */
function parseMRZ_TR(text){
  if(!text) return null;
  const lines = text.trim().split(/\n+/).map(s=>s.replace(/\s+/g,'').toUpperCase());
  const MRZ = lines.slice(-3);
  if(MRZ.length < 2) return null;
  let l1 = MRZ[0]||'', l2 = MRZ[1]||'', l3 = MRZ[2]||'';

  let tckn = '';
  if(l1){
    const r = l1.replace(/</g,'').toUpperCase();
    const digits = normalizeDigits(r).replace(/\D/g,'');
    if(/\d{11}$/.test(digits)){
      const cand = digits.slice(-11);
      if(isValidTCKN(cand)) tckn = cand;
    }
  }

  let dogum = '';
  if(l2){
    const six = (l2.match(/^\d{6}/) || [])[0] || normalizeDigits(l2).match(/^\d{6}/)?.[0];
    if(six){
      const yy = six.slice(0,2), mm = six.slice(2,4), dd = six.slice(4,6);
      const ok = isValidDateYYYYMMDD(yy,mm,dd);
      if(ok) dogum = ok;
    }
  }

  let ad='', soyad='';
  if(l3 && l3.includes('<<')){
    const [s,g] = l3.split('<<');
    soyad = s.replace(/</g,' ').trim().replace(/\s+/g,' ');
    ad = (g||'').replace(/</g,' ').trim().replace(/\s+/g,' ');
  }

  const basicOk = (ad||soyad||dogum||tckn);
  if(!basicOk) return null;
  return { ad, soyad, dogum, tckn, l1, l2, l3, _score: scoreMRZ(l1,l2,l3) };
}
function fillForm(obj){
  if(!obj) return;
  $('#tckn').value = obj.tckn||'';
  $('#ad').value = obj.ad||'';
  $('#soyad').value = obj.soyad||'';
  $('#dogum').value = obj.dogum||'';
  if(obj.raw) $('#raw').value = obj.raw;
}

/* ==================== Kamera listesi / seçim ==================== */
function preferBack(list){
  const score = d=>{
    const L=(d.label||'').toLowerCase(); let s=0;
    if(/back|rear|environment/.test(L)) s+=5;
    if(/front|user/.test(L)) s-=4;
    if(/tele|macro|3x|5x/.test(L)) s+=1;
    if(/camera\s*0.*back/.test(L)) s+=2;
    return s;
  };
  return list.slice().sort((a,b)=>score(b)-score(a));
}
async function listCameras(){
  try{ const tmp = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch(_){}
  let all = await navigator.mediaDevices.enumerateDevices();
  all = all.filter(d=>d.kind==='videoinput');
  devices = preferBack(all);
  const sel = $('#camera'); sel.innerHTML='';
  devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(o); });
  deviceIndex=0; sel.value='0';
  log('Kameralar:', devices);
}

/* ==================== Video oynatma güvencesi ==================== */
function waitForFirstFrame(video){
  return new Promise(resolve=>{
    if(video.readyState>=2 && video.videoWidth>0){ return resolve(); }
    let done=false;
    const settle=()=>{ if(!done && video.videoWidth>0){ done=true; resolve(); } };
    video.addEventListener('canplay', ()=>settle(), {once:true});
    if('requestVideoFrameCallback' in video){
      video.requestVideoFrameCallback(()=>settle());
    }else{
      const iv=setInterval(()=>{ if(done) return clearInterval(iv); if(video.videoWidth>0){ clearInterval(iv); settle(); } }, 50);
    }
    setTimeout(()=>settle(), 3000);
  });
}
async function tryPlay(video){
  try{
    video.muted=true; video.setAttribute('muted',''); video.setAttribute('playsinline','');
    await video.play(); $('#tapOverlay').style.display='none'; return true;
  }catch(e){
    log('video.play reddedildi:', e.name, e.message);
    $('#tapOverlay').style.display='flex';
    return new Promise(res=>{
      $('#btnTap').onclick = async ()=>{
        try{ await video.play(); $('#tapOverlay').style.display='none'; res(true); }
        catch(e2){ log('tap play hata:', e2.name, e2.message); res(false); }
      };
    });
  }
}

/* ==================== Akış kontrolü ==================== */
async function stopAll(){
  showScanline(false);
  if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
  if(codeReader){ try{ await codeReader.reset(); }catch(_){ } codeReader=null; }
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  currentStream=null; currentMode=null;
  $('#btnBarcode').disabled=true; $('#btnMRZ').disabled=true; $('#btnStop').disabled=true;
}
async function openCamera(){
  await stopAll();
  const dev = devices[deviceIndex];
  if(!dev){ setStatus('Kamera bulunamadı.'); return false; }
  const low = $('#lowres').checked;
  const constraints = {
    video: {
      deviceId: { exact: dev.deviceId },
      facingMode: 'environment',
      width: low ? {ideal:1280} : {ideal:1920},
      height: low ? {ideal:720} : {ideal:1080},
      frameRate: { ideal: 30 },
      advanced: [{ focusMode:'continuous' }]
    },
    audio:false
  };
  setStatus('Kamera açılıyor…');
  const v = $('#video');
  try{
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream; v.srcObject = stream;
    const played = await tryPlay(v);
    if(!played){ setStatus('Videoyu başlatmak için butona dokunun.'); return false; }
    await waitForFirstFrame(v);
    setStatus('Kamera açık.');
    $('#btnBarcode').disabled=false; $('#btnMRZ').disabled=false; $('#btnStop').disabled=false;
    return true;
  }catch(e){
    log('getUserMedia hata:', e.name, e.message);
    if(e.name==='NotAllowedError') setStatus('Kamera izni verilmedi.');
    else if(e.name==='NotReadableError') setStatus('Kamera başka uygulama tarafından kullanılıyor olabilir.');
    else setStatus('Kamera açılamadı: '+e.message);
    return false;
  }
}

/* ==================== Ortak Sonuç İşleme ==================== */
function onScan(text, src, parsed){
  $('#raw').value = text||'';
  let obj = parsed || {};
  if(src==='barcode'){
    const t = extractTCKNAnywhere(text);
    if(t && !obj.tckn) obj.tckn = t;
    const maybeMRZ = parseMRZ_TR(text); // barkodda MRZ varsa
    if(maybeMRZ){ obj = {...maybeMRZ, raw:text}; }
  }
  obj.raw = text;
  fillForm(obj);
  setStatus(src==='mrz' ? 'MRZ okundu.' : 'Barkod okundu.');
}

/* ==================== Barkod (ZXing — SADECE vendor) ==================== */
async function startBarcode(){
  if(!currentStream){ const ok = await openCamera(); if(!ok) return; }
  const okLib = await loadZXingVendorOnly();
  if(!okLib){
    setStatus('ZXing vendor bulunamadı. Aynı klasöre "zxing-browser-0.1.4.min.js" koyun (veya /vendor/).');
    return;
  }
  currentMode='barcode'; showScanline(true); setStatus('Barkod taranıyor…');

  const hints = new Map();
  const BF = ZXingBrowser.BarcodeFormat;
  hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS,[BF.PDF_417,BF.QR_CODE,BF.CODE_128]);
  codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);

  setTimeout(()=> {
    try{
      codeReader.decodeFromVideoElementContinuously($('#video'), (res, err)=>{
        if(res){
          showScanline(false);
          const txt = res.getText ? res.getText() : (res.text || '');
          onScan(txt, 'barcode');
        }
      });
    }catch(e){ log('ZXing start hata:', e); setStatus('Barkod okuyucu hatası: '+e.message); }
  }, 300);
}

/* ==================== Basit görüntü işleme ==================== */
/* gri + global ikili (eşik) */
function binarize(ctx, w, h, thr=140){
  const img=ctx.getImageData(0,0,w,h), d=img.data;
  for(let i=0;i<d.length;i+=4){
    const g=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
    const bw=g>thr?255:0; d[i]=d[i+1]=d[i+2]=bw;
  }
  ctx.putImageData(img,0,0);
}
/* hafif keskinleştirme (unsharp-ish) */
function sharpen(ctx, w, h){
  const img=ctx.getImageData(0,0,w,h), d=img.data.slice();
  const out=ctx.getImageData(0,0,w,h), o=out.data;
  const off=[-w*4,0,w*4,-4,4]; // yukarı, merkez, aşağı, sol, sağ
  for(let i=0;i<o.length;i+=4){
    let sum = 0, cnt=0;
    for(const k of off){
      const j=i+k;
      if(j>=0 && j<d.length){
        const g=(d[j]*0.299 + d[j+1]*0.587 + d[j+2]*0.114)|0;
        sum+=g; cnt++;
      }
    }
    const center=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
    let val = Math.min(255, Math.max(0, center*1.5 - (sum/cnt)*0.5));
    o[i]=o[i+1]=o[i+2]=val; o[i+3]=255;
  }
  ctx.putImageData(out,0,0);
}

/* Bir satırı OCR et (confidence ile) */
async function ocrWithWorker(canvas, params){
  if(mrzWorker==='legacy'){
    const r = await Tesseract.recognize(canvas,'eng',params||{});
    const text = (r.data && r.data.text) ? r.data.text : '';
    const conf = (r.data && typeof r.data.confidence==='number') ? r.data.confidence : 0;
    return { text, conf };
  }
  if(params) await mrzWorker.setParameters(params);
  const r = await mrzWorker.recognize(canvas);
  const text = (r.data && r.data.text) ? r.data.text : '';
  const conf = (r.data && typeof r.data.confidence==='number') ? r.data.confidence : 0;
  return { text, conf };
}

/* ==================== MRZ (Stabil: çoklu eşik + vote + skor) ==================== */
async function ensureMRZWorker(){
  if(mrzWorker) return true;
  const okLib = await loadTesseract();
  if(!okLib){ setStatus('Tesseract yüklenemedi (CDN engelli ise /vendor/tesseract-4.0.2.min.js ekleyin).'); return false; }
  try{
    if(Tesseract.createWorker){
      mrzWorker = await Tesseract.createWorker({ logger: null });
      await mrzWorker.load();
      await mrzWorker.loadLanguage('eng');
      await mrzWorker.initialize('eng');
      await mrzWorker.setParameters({
        tessedit_pageseg_mode: '7',
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'
      });
      log('MRZ worker hazır.');
      return true;
    }else{
      mrzWorker = 'legacy';
      log('Tesseract legacy modda çalışacak.');
      return true;
    }
  }catch(e){ log('MRZ worker hata:', e); return false; }
}

async function startMRZ(){
  if(!currentStream){ const ok = await openCamera(); if(!ok) return; }
  const okW = await ensureMRZWorker();
  if(!okW) return;

  currentMode='mrz'; showScanline(true); setStatus('MRZ taranıyor…');

  const v=$('#video');
  const bandCanvas=document.createElement('canvas'), bctx=bandCanvas.getContext('2d');
  const l1c=document.createElement('canvas'), l1ctx=l1c.getContext('2d');
  const l2c=document.createElement('canvas'), l2ctx=l2c.getContext('2d');
  const l3c=document.createElement('canvas'), l3ctx=l3c.getContext('2d');

  mrzBusy=false;
  stabWin.l1=[]; stabWin.l2=[]; stabWin.l3=[];

  function prepLine(ctxDst, src, sx, sy, sw, sh, scale=2, thr=140){
    ctxDst.canvas.width = Math.max(700, Math.floor(sw*scale));
    ctxDst.canvas.height = Math.floor(sh*scale);
    ctxDst.drawImage(src, sx, sy, sw, sh, 0, 0, ctxDst.canvas.width, ctxDst.canvas.height);
    // hafif keskin + ikili
    sharpen(ctxDst, ctxDst.canvas.width, ctxDst.canvas.height);
    binarize(ctxDst, ctxDst.canvas.width, ctxDst.canvas.height, thr);
  }

  function chooseBestVariant(ctx, sx, sy, sw, sh, scale, thresholds, params){
    // Birden çok eşik dene, en iyi skorlu MRZ parçasını seç
    const cand = [];
    for(const thr of thresholds){
      const tmp = document.createElement('canvas');
      const tctx = tmp.getContext('2d');
      tctx.canvas.width = Math.max(700, Math.floor(sw*scale));
      tctx.canvas.height = Math.floor(sh*scale);
      tctx.drawImage(ctx.canvas, sx, sy, sw, sh, 0, 0, tctx.canvas.width, tctx.canvas.height);
      sharpen(tctx, tctx.canvas.width, tctx.canvas.height);
      binarize(tctx, tctx.canvas.width, tctx.canvas.height, thr);
      cand.push({canvas: tmp, thr});
    }
    return cand;
  }

  const thresholds = [110,125,140,160];

  const tick = async ()=>{
    if(currentMode!=='mrz' || mrzBusy || !v.videoWidth){ return; }
    mrzBusy=true;
    try{
      const vw=v.videoWidth, vh=v.videoHeight;
      const bandH = Math.floor(vh*0.34), bandY = vh - bandH;
      const scaleBand = 2;

      // band hazırlığı
      bandCanvas.width = Math.floor(vw*scaleBand);
      bandCanvas.height = Math.floor(bandH*scaleBand);
      bctx.drawImage(v, 0, bandY, vw, bandH, 0,0, bandCanvas.width, bandCanvas.height);

      // kaba ikili (band genel)
      binarize(bctx, bandCanvas.width, bandCanvas.height, 135);

      // 3 satırı yaklaşık konumdan al (eşit böl)
      const lineH = Math.floor(bandCanvas.height/3);
      // her satır için çoklu eşik varyantları üret
      const vL1 = chooseBestVariant(bctx, 0, 0*lineH, bandCanvas.width, lineH, 1.8, thresholds);
      const vL2 = chooseBestVariant(bctx, 0, 1*lineH, bandCanvas.width, lineH, 1.8, thresholds);
      const vL3 = chooseBestVariant(bctx, 0, 2*lineH, bandCanvas.width, lineH, 2.0, thresholds);

      // OCR param setleri
      const pNum = {tessedit_pageseg_mode:'7',tessedit_char_whitelist:'0123456789<', classify_bln_numeric_mode:'1'};
      const pAlpha = {tessedit_pageseg_mode:'7',tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ<'};
      const pMix = {tessedit_pageseg_mode:'7',tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'};

      // her varyant için OCR → en iyi skoru seç
      async function bestOf(variants, params, postProc){
        let best={text:'',conf:0};
        for(const {canvas,thr} of variants){
          const {text, conf} = await ocrWithWorker(canvas, params);
          const clean = (postProc(text)||'').toUpperCase().trim();
          const effective = clean.replace(/[^\dA-Z<\n]/g,'');
          if(effective.length===0) continue;
          // basit kalite metriği: conf + uzunluk
          const quality = (conf||0) + effective.length*1.5;
          if(quality > (best.q||-1)){
            best = {text: effective, conf, q: quality};
          }
        }
        return best.text;
      }
      const l2 = await bestOf(vL2, pNum, t=>t.replace(/[^\d<\n]/g,''));
      const l3 = await bestOf(vL3, pAlpha, t=>t.replace(/[^A-Z<\n]/g,''));
      const l1 = await bestOf(vL1, pMix, t=>t.replace(/[^\dA-Z<\n]/g,''));

      // stabilizasyon havuzuna at
      pushStab('l1', l1); pushStab('l2', l2); pushStab('l3', l3);

      // majority vote
      const s1 = majority(stabWin.l1);
      const s2 = majority(stabWin.l2);
      const s3 = majority(stabWin.l3);

      const cleaned = [s1,s2,s3].filter(Boolean).join('\n');
      if(cleaned.replace(/\s/g,'').length>20){
        const mrz = parseMRZ_TR(cleaned);
        if(mrz){
          // skor bazlı “tamamlandı” eşiği
          const okScore = mrz._score >= 12 && (mrz.tckn || mrz.dogum);
          if(okScore){
            showScanline(false);
            mrz.raw = cleaned;
            onScan(cleaned, 'mrz', mrz);
            setStatus('MRZ okundu.');
          }else{
            setStatus('MRZ kısmen tanındı, netleştiriliyor…');
            $('#raw').value = cleaned;
          }
        }else{
          setStatus('MRZ yakalandı; ayrıştırılamadı (açı/ışık).');
          $('#raw').value = cleaned;
        }
      }else{
        setStatus('MRZ bekleniyor… Kartı düz ve yakın tutun.');
      }
    }catch(e){
      log('MRZ tick hata:', e.name || e, e.message||'');
    }finally{
      mrzBusy=false;
    }
  };

  // Daha sık ama çakışmasız (busy bayrağı)
  scanTimer = setInterval(tick, 600);
}

/* ==================== UI Olayları ==================== */
$('#btnOpen').addEventListener('click', async ()=>{
  try{ await listCameras(); const ok = await openCamera(); if(!ok) return; }catch(e){ log('btnOpen hata:', e.name, e.message); }
});
$('#btnStop').addEventListener('click', async ()=>{ await stopAll(); setStatus('Durduruldu.'); });
$('#btnBarcode').addEventListener('click', async ()=>{ try{ await startBarcode(); }catch(e){ log('startBarcode hata:', e.name, e.message); } });
$('#btnMRZ').addEventListener('click', async ()=>{ try{ await startMRZ(); }catch(e){ log('startMRZ hata:', e.name, e.message); } });
$('#camera').addEventListener('change', async ()=>{ deviceIndex=+$('#camera').value; if(currentStream){ await openCamera(); } });

/* Kayıt ekleme / silme / dışa aktarım */
$('#btnSave').addEventListener('click', ()=>{
  const rec = {
    tckn: $('#tckn').value.trim(),
    ad: $('#ad').value.trim(),
    soyad: $('#soyad').value.trim(),
    dogum: $('#dogum').value.trim(),
    raw: $('#raw').value.trim(),
    ts: new Date().toISOString()
  };
  const list = loadRecords(); list.push(rec); saveRecords(list);
  setStatus('Kayıt eklendi.');
});
$('#btnClear').addEventListener('click', ()=>{
  if(confirm('Tüm kayıtları silmek istiyor musunuz?')) saveRecords([]);
});
$('#btnExport').addEventListener('click', ()=>{
  const list = loadRecords();
  if(!list.length){ alert('Dışa aktarılacak kayıt yok.'); return; }
  const header = 'TCKN;AD;SOYAD;DOGUM_TARIHI;RAW\n';
  const lines = list.map(r => [r.tckn||'',r.ad||'',r.soyad||'',r.dogum||'', (r.raw||'').replace(/\n/g,' ')].join(';'));
  const blob = new Blob(['\ufeff'+header + lines.join('\n')], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'kimlik_kayitlari.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  setStatus('TXT dışa aktarıldı.');
});

/* İlk yükleme: sadece kameraları listele (akış açılmaz) */
(async()=>{ try{ await listCameras(); }catch(e){ log('listeleme hata:', e.name, e.message); } })();

/* Kayıt varsa export/clear aktif */
toggleExportButtons();
</script>
</body>
</html>

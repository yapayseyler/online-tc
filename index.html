<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>MRZ Okuyucu — Normal Arka Kamera (Balık gözü yok)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e6eef8; }
    header { padding:14px 16px; border-bottom:1px solid #1f2733; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    header h1 { font-size:16px; margin:0; color:#cfe1ff; }
    .ctrls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select, button, label { font-size:14px; }
    select, button { border:1px solid #2a3547; background:#162032; color:#e6eef8; padding:8px 12px; border-radius:10px; }
    button { cursor:pointer; font-weight:600; }
    button:disabled{opacity:.6; cursor:not-allowed;}
    label { color:#9bb0c9; user-select:none; }
    main { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; padding:16px; }
    .panel { background:#0f1520; border:1px solid #1d2633; border-radius:12px; overflow:hidden; }
    .panel h2 { font-size:14px; margin:0; padding:10px 12px; border-bottom:1px solid #1d2633; color:#b9c8da;}
    .content { padding:12px; }
    #video { width:100%; border-radius:8px; background:#000; }
    .frame { position:relative; }
    .mrz-window {
      position:absolute; left:5%; right:5%; height:26%;
      bottom:8%; border:2px dashed #58a6ff88; border-radius:8px; box-shadow:0 0 0 200vmax #0000 inset;
    }
    .hint { font-size:12px; color:#9bb0c9; line-height:1.5; }
    pre { white-space:pre-wrap; background:#0c111b; padding:10px; border-radius:8px; border:1px solid #1d2633; }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap:6px; font-size:14px; padding:6px 8px; border-bottom:1px dashed #223049; }
    .kv b { color:#cfe1ff; }
    .grid { display:grid; gap:10px; }
    footer { padding:10px 16px; font-size:12px; color:#8fa8c7; border-top:1px solid #1f2733; }
    /* Autoplay engellenirse üzerine tıklatmak için */
    #tapOverlay { display:none; position:absolute; inset:0; align-items:center; justify-content:center; background: #0006; border-radius:8px; }
    #tapOverlay button{ background:#0d6efd; border:0; padding:10px 14px; border-radius:10px; color:#fff; font-weight:700; }
  </style>
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- MRZ ayrıştırıcı (ESM) -->
  <script type="module" id="mrz-module">
    import { parse as parseMrz } from 'https://unpkg.com/mrz@4.2.1/lib-esm/index.js';
    window.__parseMrz = parseMrz;
  </script>
</head>
<body>
  <header>
    <h1>MRZ Okuyucu — Normal Arka Kamera</h1>
    <div class="ctrls">
      <select id="camera" title="Kamera seç">
        <option>— kameralar yükleniyor —</option>
      </select>
      <label><input type="checkbox" id="lowres" /> Düşük çözünürlük (1280×720)</label>
      <button id="btnOpen">Kamerayı Aç</button>
      <button id="btnStop" disabled>Kapat</button>
      <button id="btnSnap" disabled>Tara</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Kamera</h2>
      <div class="content grid">
        <div class="frame">
          <video id="video" autoplay playsinline></video>
          <div id="tapOverlay"><button id="btnTap">Videoyu Başlat</button></div>
          <div class="mrz-window" title="MRZ penceresi"></div>
        </div>
        <div class="hint">
          • MRZ, belgenin altındaki 2–3 satırlık makine okunur alandır. Pencereyi MRZ hizasına getir.<br/>
          • Ultra-wide veya balık gözü bozar — bu sayfa **normal arka kamera**yı otomatik seçer. Gerekirse menüden değiştir.<br/>
          • Işık iyi olmalı; parlamadan kaçın.
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>Sonuç</h2>
      <div class="content grid">
        <div>
          <div id="status" class="hint">Hazır.</div>
          <pre id="rawText" class="mono"></pre>
        </div>
        <div id="fields"></div>
      </div>
    </section>
  </main>

  <footer>
    Tamamen tarayıcıda çalışır. Normal arka kamera öncelikli seçilir; MRZ OCR için Tesseract.js ve ayrıştırma için <code>mrz</code> kütüphanesi kullanılır.
  </footer>

<script>
(function(){
  // Kısa yardımcılar
  const $ = (q)=>document.querySelector(q);

  const video = $('#video');
  const canvas= $('#canvas');
  const statusEl = $('#status');
  const rawText = $('#rawText');
  const fieldsEl = $('#fields');

  const btnOpen = $('#btnOpen');
  const btnStop = $('#btnStop');
  const btnSnap = $('#btnSnap');
  const selCamera = $('#camera');

  let currentStream = null;
  let devices = [];
  let deviceIndex = 0; // her zaman arka-normal kamera hedeflenecek

  function setStatus(t){ statusEl.textContent = t; }
  function log(){ /* console.log.apply(console, arguments); */ }

  // ------- Kamera seçim mantığı (balık gözü yerine normal arka) -------
  function scoreDevice(d){
    const L = (d.label||'').toLowerCase();

    let s = 0;
    // Arka / normal lensi yükselt
    if (/back|rear|environment|main|standard|regular/.test(L)) s += 8;
    if (/camera\s*0\b/.test(L)) s += 2; // çoğu cihazda "main" genelde 0'dır

    // Ön kamera ve kullanıcı tarafını düşür
    if (/front|user|selfie/.test(L)) s -= 6;

    // Ultra wide / fisheye / macro gibi lensleri düşür
    if (/ultra[-\s]?wide|\buw\b|super[-\s]?wide|fisheye|macro|depth|bokeh|wide\s*angle/.test(L)) s -= 8;

    // Belirsiz ise ama arka ipucu varsa
    if (!d.label && d.kind==='videoinput') s += 0;

    return s;
  }
  function preferBack(list){
    return list.slice().sort((a,b)=> scoreDevice(b) - scoreDevice(a));
  }

  async function listCameras(){
    // Etiketleri görebilmek için bir kere izin iste
    try{
      const tmp = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      tmp.getTracks().forEach(t=>t.stop());
    }catch(_){ /* kullanıcı iptal etmiş olabilir; yine de enumerate deneriz */ }

    let all = await navigator.mediaDevices.enumerateDevices();
    all = all.filter(d=>d.kind==='videoinput');

    devices = preferBack(all);

    selCamera.innerHTML = '';
    devices.forEach((d,i)=>{
      const o=document.createElement('option');
      o.value = i;
      o.textContent = d.label || `Kamera ${i+1}`;
      selCamera.appendChild(o);
    });

    // otomatik: en iyi skorlu cihaz (muhtemelen normal arka) -> index 0
    deviceIndex = 0;
    selCamera.value = String(deviceIndex);
  }

  async function stopAll(){
    if(currentStream){
      currentStream.getTracks().forEach(t=>t.stop());
      currentStream = null;
    }
    btnSnap.disabled = true;
    btnStop.disabled = true;
  }

  async function openCamera(){
    await stopAll();

    const dev = devices[deviceIndex];
    if(!dev){ setStatus('Kamera bulunamadı.'); return false; }

    const low = $('#lowres').checked;
    // Not: deviceId 'exact' ile **seçilen lens**e kilitleniyoruz (ultra-wide kaçsın)
    const constraints = {
      video: {
        deviceId: { exact: dev.deviceId },
        facingMode: 'environment',
        width:  low ? { ideal: 1280 } : { ideal: 1920 },
        height: low ? { ideal: 720  } : { ideal: 1080 },
        frameRate: { ideal: 30 },
        advanced: [{ focusMode: 'continuous' }]
      },
      audio: false
    };

    setStatus('Kamera açılıyor…');
    try{
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;
      video.srcObject = stream;

      try{
        await video.play();
        $('#tapOverlay').style.display='none';
      }catch(_){
        // Autoplay engellenirse
        $('#tapOverlay').style.display='flex';
        $('#btnTap').onclick = ()=> video.play().then(()=> $('#tapOverlay').style.display='none');
      }

      // Arka kamera olduğundan görüntüyü aynalamıyoruz
      video.style.transform = '';

      setStatus(`Kamera açık: ${(dev.label||'seçili cihaz')}. MRZ penceresine hizala ve Tara.`);
      btnSnap.disabled = false;
      btnStop.disabled = false;
      return true;
    }catch(e){
      log('getUserMedia hata:', e.name, e.message);
      setStatus('Kamera açılamadı: ' + e.message);
      return false;
    }
  }

  // Kamera menüsü değiştiğinde hemen o kamerayı aç
  document.addEventListener('change', async (ev)=>{
    if(ev.target && ev.target.id === 'camera'){
      deviceIndex = +ev.target.value || 0;
      if(devices[deviceIndex]){ await openCamera(); }
    }
  });

  // ------- MRZ OCR + Ayrıştırma -------
  function normalizeMrzText(t){
    const keep = /[A-Z0-9<\n]/g;
    const up = (t || '').toUpperCase().match(keep)?.join('') || '';
    return up.replace(/ /g,'').replace(/\u00A0/g,'');
  }
  function pickMrzLines(text){
    const lines = text.split(/\n+/).map(s => s.trim()).filter(Boolean);
    const candidates = lines.filter(s => s.length >= 25);
    return candidates.slice(-3);
  }
  function renderFields(obj){
    const kv = [];
    function row(k, v){ kv.push(`<div class="kv"><b>${k}</b><span>${v ?? ''}</span></div>`); }
    fieldsEl.innerHTML = '';

    if(!obj || !obj.fields){
      fieldsEl.innerHTML = '<div class="hint">MRZ ayrıştırılamadı. Farklı açı/ışıkla tekrar deneyin.</div>';
      return;
    }
    const f = obj.fields;
    row('Belge türü', f.documentType);
    row('Ülke', f.issuingCountry);
    row('Soyad', f.lastName);
    row('İsimler', f.firstName);
    row('Belge No', f.documentNumber);
    row('Uyruk', f.nationality);
    row('Doğum Tarihi', f.birthDate);
    row('Cinsiyet', f.sex);
    row('Son Geçerlilik', f.expirationDate);
    row('Opsiyonel Alan', f.optional);
    fieldsEl.innerHTML = kv.join('');
  }

  function takeMrzCrop(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if(!vw || !vh){ throw new Error('Video hazır değil.'); }

    const x = Math.round(vw * 0.05);
    const w = Math.round(vw * 0.90);
    const h = Math.round(vh * 0.26);
    const y = Math.round(vh * 0.66);

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, x, y, w, h, 0, 0, w, h);
    return canvas;
  }

  async function scan(){
    if(!window.__parseMrz){
      setStatus('MRZ ayrıştırıcı yüklenmedi.');
      return;
    }
    btnSnap.disabled = true;
    try{
      const cropCanvas = takeMrzCrop();

      setStatus('OCR çalışıyor… (Tesseract.js)');
      const { data } = await Tesseract.recognize(
        cropCanvas,
        'eng',
        {
          logger: m => { if(m.status) setStatus(`${m.status}… ${Math.round((m.progress||0)*100)}%`); },
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
          preserve_interword_spaces: '1',
          user_defined_dpi: '300',
          oem: 1
        }
      );

      const normalized = normalizeMrzText(data.text);
      rawText.textContent = normalized || '(metin bulunamadı)';

      const lines = pickMrzLines(normalized);
      let mrzBlock = '';
      if(lines.length >= 3){
        const last3 = lines.slice(-3);
        if(last3[0].length >= 28 && last3[1].length >= 28 && last3[2].length >= 28){
          mrzBlock = last3.join('\n');
        }
      }
      if(!mrzBlock && lines.length >= 2){
        mrzBlock = lines.slice(-2).join('\n');
      }

      if(!mrzBlock){
        setStatus('MRZ bulunamadı. Yeniden deneyin.');
        renderFields(null);
        return;
      }

      setStatus('MRZ ayrıştırılıyor…');
      const parsed = window.__parseMrz(mrzBlock);
      renderFields(parsed);
      setStatus('Bitti ✅');
    }catch(err){
      console.error(err);
      setStatus('Hata: ' + (err.message || err));
      renderFields(null);
    }finally{
      btnSnap.disabled = !currentStream;
    }
  }

  // ------- Olaylar -------
  btnOpen.addEventListener('click', openCamera);
  btnStop.addEventListener('click', stopAll);
  btnSnap.addEventListener('click', scan);

  // Sayfa açılınca kameraları sırala (arka-normal öncelikli)
  (async function init(){
    setStatus('Kameralar listeleniyor…');
    await listCameras();
    setStatus('Hazır. "Kamerayı Aç" ile normal arka kamerayı başlat.');
  })();
})();
</script>
</body>
</html>

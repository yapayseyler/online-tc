<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kamera Test + Barkod/MRZ</title>
<style>
body{margin:0;background:#111;color:#eee;font-family:sans-serif}
.wrap{padding:12px;max-width:900px;margin:auto}
.card{background:#1a1a1a;padding:12px;border-radius:8px;margin-bottom:12px}
video{width:100%;max-height:50vh;background:#000;border-radius:8px}
button{margin:4px;padding:10px 16px;border:0;border-radius:6px;background:#4f8cff;color:#fff;font-weight:600}
button.secondary{background:#333}
textarea,input{width:100%;padding:8px;margin-top:4px;border-radius:4px;border:1px solid #333;background:#000;color:#fff}
</style>
<script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <button id="btnBarcode">Barkod Tara</button>
    <button id="btnMRZ" class="secondary">MRZ Tara</button>
    <button id="btnStop" class="secondary">Durdur</button>
    <div id="status">Hazır.</div>
  </div>
  <div class="card">
    <select id="camera"></select>
    <video id="video" autoplay playsinline muted></video>
  </div>
  <div class="card">
    <textarea id="raw" rows="4" placeholder="Ham veri..."></textarea>
  </div>
</div>
<script>
let devices=[],currentStream=null,currentMode=null,codeReader=null;

async function listCameras(){
  await navigator.mediaDevices.getUserMedia({video:true}).then(s=>s.getTracks().forEach(t=>t.stop()));
  devices=await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  const sel=document.getElementById('camera');
  sel.innerHTML='';
  devices.forEach((d,i)=>{
    const opt=document.createElement('option');
    opt.value=i; opt.text=d.label||`Kamera ${i+1}`;
    sel.appendChild(opt);
  });
}
async function openCamera(index){
  stopCamera();
  const device=devices[index];
  const constraints={video:{deviceId:{exact:device.deviceId}},audio:false};
  currentStream=await navigator.mediaDevices.getUserMedia(constraints);
  const v=document.getElementById('video');
  v.srcObject=currentStream;
  await v.play();
}
function stopCamera(){
  if(codeReader) try{codeReader.reset();}catch(e){}
  if(currentStream){currentStream.getTracks().forEach(t=>t.stop());}
  currentStream=null;
}
function handleResult(text){
  document.getElementById('raw').value=text;
  document.getElementById('status').textContent='Okundu.';
}
async function startBarcode(){
  currentMode='barcode';
  document.getElementById('status').textContent='Barkod taranıyor...';
  await openCamera(document.getElementById('camera').value);
  codeReader=new ZXingBrowser.BrowserMultiFormatReader();
  codeReader.decodeFromVideoElementContinuously(document.getElementById('video'),(res,err)=>{
    if(res) handleResult(res.getText());
  });
}
async function startMRZ(){
  currentMode='mrz';
  document.getElementById('status').textContent='MRZ taranıyor...';
  await openCamera(document.getElementById('camera').value);
  const v=document.getElementById('video');
  const c=document.createElement('canvas'),ctx=c.getContext('2d');
  setInterval(async()=>{
    if(currentMode!=='mrz'||!v.videoWidth) return;
    c.width=v.videoWidth; c.height=v.videoHeight*0.3;
    ctx.drawImage(v,0,v.videoHeight*0.7,v.videoWidth,v.videoHeight*0.3,0,0,c.width,c.height);
    const {data:{text}}=await Tesseract.recognize(c,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'});
    if(text.trim().length>20) handleResult(text);
  },2000);
}
document.getElementById('btnBarcode').onclick=startBarcode;
document.getElementById('btnMRZ').onclick=startMRZ;
document.getElementById('btnStop').onclick=()=>{stopCamera();document.getElementById('status').textContent='Durduruldu.';};
document.getElementById('camera').onchange=()=>{
  if(currentMode) openCamera(document.getElementById('camera').value);
};
listCameras();
</script>
</body>
</html>
